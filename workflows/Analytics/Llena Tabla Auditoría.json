{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-01-06T03:58:26.000Z",
    "createdAt": "2026-01-06T03:58:23.007Z",
    "versionId": "fcb8c632-a0be-4420-8074-a1f3a280b1e3",
    "workflowId": "kKkB2zB1kibZ3wus",
    "nodes": [
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "WITH raw_messages AS (\n    -- Paso 1: Obtenemos los últimos 10 registros de la tabla principal\n    SELECT \n        id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'main' as source\n    FROM osaki_main.n8n_chat_histories\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n\n    UNION \n    -- Paso 2: Obtenemos los últimos 10 registros del backup\n    SELECT \n        old_id as id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'backup' as source\n    FROM osaki_main.n8n_chat_histories_bkup\n    WHERE session_id = $1\n      AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n  ),\ncleaned_content AS (\n    -- Paso 3: Limpiamos el ruido inicial (ej: [Used tools...]) una sola vez\n    SELECT \n        id,\n        type,\n        regexp_replace(raw_content, '^\\[Used tools:.*\\]\\]\\s*', '') AS content\n    FROM raw_messages\n)\n-- Paso 4: Aplicamos la lógica de extracción de fecha y texto final\nSELECT\n    CASE \n        WHEN type = 'human' THEN \n            to_char(\n                to_timestamp(\n                    -- Extraemos la fecha y normalizamos guiones a barras\n                    replace(\n                        substring(content FROM '(?i)fecha\\s*y\\s*hora:\\s*([0-9]{4}[/-][0-9]{2}[/-][0-9]{2}\\s*[0-9]{2}:[0-9]{2}:[0-9]{2})'),\n                        '-', '/'\n                    ), \n                    'YYYY/MM/DD HH24:MI:SS'\n                ), \n                'YYYY/MM/DD HH24:MI:SS'\n            )\n        ELSE NULL \n    END AS fecha_hora,\n    \n    id,\n    type,\n    \n    CASE \n        WHEN type = 'human' THEN \n            trim(\n                regexp_replace(\n                    split_part(content, 'Mensaje de Texto o Descripción:', 2),\n                    '\\s+', ' ', 'g'\n                )\n            )\n        ELSE content \n    END AS content\nFROM cleaned_content\nORDER BY id asc;\n",
          "options": {
            "queryReplacement": "={{ $json.session_id }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -560,
          208
        ],
        "id": "d8227be3-4d73-4470-bec7-d1414cfb11fa",
        "name": "Get Conversation",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ JSON.stringify({\n  conversation_id: $('Loop Over Items').item.json.session_id ,\n  messages: $input.all().map(i => i.json)\n}) }}\n",
          "options": {
            "systemMessage": "=ROL\nEres un auditor automático de conversaciones de WhatsApp para un agente de RESERVAS de restaurante. (Humano = cliente, AI = bot del negocio).\nTu tarea es analizar una conversación (lista de mensajes) y producir UN ÚNICO JSON con las columnas de la tabla\nauditoria_conversacion_reservas.\n\nREGLA CRÍTICA ANTI-ALUCINACIÓN (OBLIGATORIA)\n- Solo puedes afirmar datos explícitos en los mensajes de entrada.\n- Si un dato no aparece o no puede inferirse de forma determinística, usa null (o [] para arreglos) y agrega el campo a datos_faltantes.\n- No inventes disponibilidad, consultas a calendario, políticas, identidades, ni acciones de herramientas.\n- Si el bot afirma “tenemos disponibilidad” o similar, y NO existe evidencia en el input de que consultó una herramienta/calendario/DB,\n  entonces afirmacion_disponibilidad_sin_fuente = true.\n\nINPUT (FORMATO)\nRecibirás un único JSON con:\n- conversation_id: string\n- messages: array de objetos { fecha_hora, id, type ('human'|'ai'), content }\n\nREGLAS DE CÁLCULO\n\n1) Normalización de timestamps\n- fecha_hora viene como string tipo \"YYYY/MM/DD HH:MM:SS\" o null.\n- Parsear solo timestamps no nulos.\n- first_user_ts = primer timestamp no nulo con type='human'\n- last_user_ts  = último timestamp no nulo con type='human'\n- duration_sec = (last_user_ts - first_user_ts) en segundos si ambos existen; si no, null.\n\n2) Sessionization\n- Nueva sesión si el gap entre MENSAJES HUMANOS consecutivos > 30 minutos.\n- session_rule = \"gap_human_gt_30m\"\n- session_count = cantidad de sesiones detectadas\n- max_gap_minutes = máximo gap (minutos) detectado entre mensajes humanos consecutivos (si hay al menos 2 timestamps humanos); si no, null.\n\n3) Conteos\n- msg_count_total = total mensajes\n- msg_count_ai = count(type='ai')\n- msg_count_human = count(type='human')\n- turn_count = min(msg_count_human, msg_count_ai) (aprox)\n\n4) Detección de intención (intent_principal) según el objetivo dominante del humano:\n- reservar -> quiere crear reserva\n- modificar_reserva -> quiere cambiar hora/fecha/zona/personas de reserva existente\n- cancelar_reserva -> quiere cancelar\n- consultar_disponibilidad -> pregunta si hay lugar\n- consultar_horarios -> horarios de atención\n- consultar_ubicacion -> dirección, mapa, sucursal\n- consultar_menu -> menú, carta\n- consultar_promociones -> promos, descuentos\n- pedido -> pedidos, delivery, take away\n- otro -> no encaja\n\nintents_secundarios: lista (sin duplicados) si detectas más de un objetivo claro.\n\n5) Resolución\n- resolution_ok = true si intent_principal fue exitoso (reserva creada/modificada/cancelada o info entregada y humano cierra conforme);\n  false si no se logró o quedó inconcluso.\n  \n- resolution_status:\n  - reservado | modificado | cancelado -> si se logró la acción principal\n  - informacion_entregada -> si se respondió consulta y humano cierra conforme\n  - derivado_humano -> si escaló a humano antes de resolución\n  - abandonado -> si humano deja de responder antes de resolución\n  - fallido -> si no se logró (ej: no hay disponibilidad, error, confusión)\n\n- no_resolution_reason SOLO si resolution_ok = false (si no aplica, null).\n  - faltan_datos_cliente -> humano no da datos necesarios (fecha, hora, pax, etc.)\n  - faltan_datos_negocio -> bot no tiene info necesaria (política, disponibilidad, etc.)\n  - error_herramienta -> falla técnica o error en consulta a herramienta\n  - politica_negocio -> política impide completar (no reservas, no cambios, etc.)\n  - loop_o_confusion -> confusión o loop sin avance claro\n  - cliente_no_responde -> humano deja de responder\n  - otro -> no encaja\n  - null -> si resolution_ok = true\n\n6) Extracción de entidades (solo si aparecen explícitas)\n- reserva_accion: \"create\" | \"modify\" | \"cancel\" (si no se identifica, null)\n- reserva_codigo: código tipo \"OSK-...\" (si aparece)\n- reserva_fecha: DATE (YYYY-MM-DD) si se puede extraer con certeza\n- reserva_hora: TIME (HH:MM:SS o HH:MM) si se puede extraer con certeza\n- reserva_pax: número de personas (>=1) si aparece\n- reserva_zona: \"Salón\", \"Barra\", etc. si aparece\n- cliente_nombre: nombre si el humano lo proporciona\n\n7) Calidad del flujo\n- confirmacion_explicita = true si la IA resume datos y pide confirmación (Sí/No o equivalente)\n- repreguntas_count: número de veces que la IA pide el mismo dato ya entregado por el humano\n- claridad_siguiente_paso:\n  - 2 si la IA deja un siguiente paso concreto y accionable (confirmar, enviar datos, presentarse a hora X, etc.)\n  - 1 si hay siguiente paso pero ambiguo\n  - 0 si no hay\n- friccion_score (0-6):\n  +2 si hay queja/enojo por parte del humano\n  +1 si la IA comete error evidente (fecha/hora/política)\n  +1 si hay confusión (“no entiendo”, “no me funciona”, “¿cómo?”)\n  +1 si hay repetición del mismo pedido por parte del humano\n  +1 si se extiende sin avance claro (o muchas vueltas)\n- consistencia_sucursal:\n  true si cuando se menciona sucursal/dirección no hay contradicción; false si cambia; null si nunca menciona.\n\n8) Escalación\n- escalado=true si la IA indica explícitamente que un humano continuará / derivación / “te contacta alguien”\n- escalacion_tipo: politica | incertidumbre | error_tecnico | queja | peticion_cliente | loop_conversacional | otro\n- escalacion_turno: turno (1..N) aproximado donde ocurrió (primer mensaje de escalación)\n- handoff_quality:\n  - 2 si deja resumen completo (problema + datos + próximo paso)\n  - 1 si deja parcial\n  - 0 si no deja contexto\n  - null si no hay escalación\n\n9) Sentimiento y tono\n- sentiment_inicio y sentiment_final: positivo | neutral | negativo | mixto | desconocido según señales textuales del HUMANO.\n- tono_ai: etiqueta breve (cordial/profesional/efusivo) según estilo del bot.\n\n10) Veracidad / riesgo\n- error_detectado = true SOLO si el chat contiene evidencia interna de error/contradicción clara por parte de la IA.\n- error_tipo: invento_info | sucursal_incorrecta | fecha_hora_incorrecta | politica_mal_aplicada | contradiccion | otro (si error_detectado=true; si no, null)\n- riesgo_negocio:\n  - high si dirección/fecha/hora/código se contradicen o confirman algo errado\n  - med si hay confusión relevante o afirmaciones sensibles sin sustento\n  - low si consistente\n- afirmacion_disponibilidad_sin_fuente = true si el bot afirma disponibilidad sin evidencia de consulta a herramienta en el input.\n\n11) Evidencia y mejoras\n- evidence_message_ids: ids numéricos de 2 a 6 mensajes clave que sustenten tus decisiones (intent, cierre, escalación, error).\n- evidence_snippet: 1-2 líneas (<= 250 caracteres) citando el contenido esencial (parafraseado o extracto corto).\n- improvement_tag: prompt | kb | flujo_preguntas | validaciones_fecha_hora | integracion_calendario | multi_sucursal | tono | seguridad_privacidad | handoff_humano | otro\n  Debe ser null si no hay mejora clara.\n- datos_faltantes: arreglo de strings con campos importantes faltantes (ej: \"reserva_fecha\", \"reserva_hora\", \"reserva_pax\") si afectó la resolución.\n\n12) entidades_json\nGenera un JSONB con:\n{\n  \"extracted\": { ...campos... },\n  \"confidence\": { \"campo\": 0.0-1.0, ... },\n  \"notes\": [ \"reglas aplicadas\", \"decisiones relevantes\" ]\n}\n\nSALIDA (FORMATO ESTRICTO)\nResponde EXCLUSIVAMENTE con UN ÚNICO JSON válido, sin markdown, sin comentarios, sin texto adicional.\nLas claves deben coincidir EXACTAMENTE con las columnas de auditoria_conversacion_reservas:\n\n```json\n{\n  \"conversation_id\": \"string\",\n  \"channel\": \"whatsapp\",\n  \"agent\": \"reservas\",\n  \"brand\": \"Osaki\",\n  \"sucursal_detectada\": \"Calle 47 - Restó\",\n  \"first_user_ts\": null, // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"last_user_ts\": null, // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"duration_sec\": null, // número o null\n  \"session_count\": 1, // número de sesiones detectadas\n  \"session_rule\": \"gap_human_gt_30m\",\n  \"max_gap_minutes\": null, // número o null\n  \"msg_count_total\": 0,  // total mensajes\n  \"msg_count_ai\": 0,    // mensajes AI\n  \"msg_count_human\": 0, // mensajes humano\n  \"turn_count\": 0,      // min(msg_count_human, msg_count_ai)\n  \"intent_principal\": \"reservar|modificar_reserva|cancelar_reserva|consultar_disponibilidad|consultar_horarios|consultar_ubicacion|consultar_menu|consultar_promociones|pedido|otro\", // ENUM ¿Cuál es el objetivo dominante del humano?\n  \"intents_secundarios\": [], // array de strings sin duplicados de intenciones secundarias detectadas\n  \"resolution_status\": \"exitoso|fallido|parcial|reservado|modificado|cancelado|informacion_entregada|derivado_humano|abandonado|otro\", // ENUM estado de resolución\n  \"resolution_ok\": \"true|false\", // boolean, si el intento principal se logró\n  \"no_resolution_reason\": \"faltan_datos_cliente|faltan_datos_negocio|error_herramienta|politica_negocio|loop_o_confusion|cliente_no_responde|otro|null\", // null si resolution_ok es true\n  \"reserva_accion\": \"create|modify|cancel|null\",  \n  \"reserva_codigo\": \"string|null\", // ejemplo: \"OSK-250101-XXXX\" \n  \"reserva_fecha\": \"YYYY-MM-DD|null\",\n  \"reserva_hora\": \"HH:MM|HH:MM:SS|null\",\n  \"reserva_pax\": \"number|null\",\n  \"reserva_zona\": \"string|null\",\n  \"cliente_nombre\": \"string|null\",\n  \"confirmacion_explicita\": \"true|false\", // boolean si la IA pide confirmación explícita\n  \"repreguntas_count\": 0, // número de repreguntas sobre datos ya dados\n  \"claridad_siguiente_paso\": \"0|1|2\",\n  \"consistencia_sucursal\": \"true|false|null\",\n  \"friccion_score\": \"0|1|2|3|4|5|6\", // 0 (sin fricción) a 6 (mucha fricción)\n  \"sentiment_inicio\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al inicio de la conversación\n  \"sentiment_final\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al final de la conversación\n  \"tono_ai\": \"cordial|profesional|efusivo|otro\", // etiqueta breve según estilo del bot\n  \"escalado\": \"true|false\", // boolean si hubo escalación a humano\n  \"escalacion_tipo\": \"politica|incertidumbre|error_tecnico|queja|peticion_cliente|loop_conversacional|otro|null\", // null si escalado es false\n  \"escalacion_turno\": \"number|null\", //  null si escalado es false\n  \"handoff_quality\": \"0|1|2|null\", // null si escalado es false\n  \"afirmacion_disponibilidad_sin_fuente\": \"true|false\", // boolean si el bot afirma disponibilidad sin evidencia de consulta a herramienta\n  \"error_detectado\": \"true|false\", // boolean si hay evidencia interna de error/contradicción por parte de la IA\n  \"error_tipo\": \"invento_info|sucursal_incorrecta|fecha_hora_incorrecta|politica_mal_aplicada|contradiccion|otro|null\", // null si error_detectado es false\n  \"riesgo_negocio\": \"high|med|low\", // nivel de riesgo detectado\n  \"improvement_tag\": \"prompt|kb|flujo_preguntas|validaciones_fecha_hora|integracion_calendario|multi_sucursal|tono|seguridad_privacidad|handoff_humano|otro|null\", // null si no aplica\n  \"evidence_message_ids\": [],\n  \"evidence_snippet\": null, // Estrictamente 1-2 líneas <= 250 caracteres, idioma español\n  \"datos_faltantes\": [],\n  \"entidades_json\": { \"extracted\": {}, \"confidence\": {}, \"notes\": [] },\n  \"messages_json\": null,\n  \"analyzed_by\": \"audit-llm-v1\"\n}\n```\n\nVALIDACIONES\n- No uses valores fuera de los ENUMS esperados.\n- Si resolution_ok=true, entonces resolution_status NO puede ser 'fallido'.\n- Si escalado=false, escalacion_tipo/escalacion_turno/handoff_quality deben ser null.\n- evidence_message_ids no puede estar vacío si resolution_ok=true o escalado=true o error_detectado=true.\n- Solo usa el idioma español en todo el output.\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3,
        "position": [
          -160,
          208
        ],
        "id": "66738309-4fdb-401e-a1d6-f38cafff5712",
        "name": "AI Agent"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          -176,
          368
        ],
        "id": "e56f0822-cf26-461e-be99-4fa24333afda",
        "name": "Google Gemini Chat Model",
        "credentials": {
          "googlePalmApi": {
            "id": "OAlDnAQJQHCtNBVS",
            "name": "Google Gemini(PaLM) Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -352,
          208
        ],
        "id": "3807f44c-2f65-4235-b096-a2384d4a9e00",
        "name": "Aggregate"
      },
      {
        "parameters": {
          "jsCode": "// Iteramos sobre todos los items\nreturn items.map(item => {\n  try {\n    // 1. Obtenemos el string\n    let rawContent = item.json.output || \"\";\n\n    // 2. Limpieza de Markdown (Como antes)\n    let cleanContent = rawContent\n      .replace(/^```json\\s*/i, '')\n      .replace(/^```\\s*/i, '')\n      .replace(/\\s*```$/, '')\n      .trim();\n\n    // -----------------------------------------------------------\n    // 3. REPARACIÓN DE JSON ROTO (El Parche)\n    // -----------------------------------------------------------\n    // El error es: cierra una propiedad con \", en lugar de },\n    // Buscamos: Salto de linea (\\n) -> Espacios (\\s*) -> Comilla (\") -> Coma (,)\n    // Y lo reemplazamos por: },\n    // Nota: Usamos una Regex específica para no romper otros textos.\n    \n    cleanContent = cleanContent.replace(/(\\n\\s*)\"\\s*,/g, '$1},');\n\n    // -----------------------------------------------------------\n\n    // 4. Parseo\n    const parsedData = JSON.parse(cleanContent);\n\n    // 5. Retorno Exitoso\n    return {\n      json: parsedData\n    };\n\n  } catch (error) {\n    // Si falla de nuevo, te dará detalles más precisos\n    return {\n      json: {\n        error: true,\n        message: \"Aún fallando el parseo. Revisa 'cleaned_string' para ver el error.\",\n        original_error: error.message,\n        // Devolvemos el string limpio para que veas si el parche funcionó visualmente\n        cleaned_string: error.input_string_debug \n      }\n    };\n  }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          176,
          208
        ],
        "id": "a530b6e1-e16c-4b9c-8270-7bb00b56ec21",
        "name": "Normaliza Salida"
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "value": "osaki_analytics",
            "mode": "list",
            "cachedResultName": "osaki_analytics"
          },
          "table": {
            "__rl": true,
            "value": "auditoria_conversacion_reservas",
            "mode": "list",
            "cachedResultName": "auditoria_conversacion_reservas"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "resolution_ok": "={{ $json.resolution_ok }}",
              "confirmacion_explicita": "={{ $json.confirmacion_explicita }}",
              "consistencia_sucursal": "={{ $json.consistencia_sucursal }}",
              "escalado": "={{ $json.escalado }}",
              "afirmacion_disponibilidad_sin_fuente": "={{ $json.afirmacion_disponibilidad_sin_fuente }}",
              "error_detectado": "={{ $json.error_detectado }}",
              "channel": "=WhatsApp",
              "agent": "=Restó",
              "brand": "=Osaki",
              "sucursal_detectada": "=Restó Calle 47",
              "first_user_ts": "={{ $json.first_user_ts }}",
              "last_user_ts": "={{ $json.last_user_ts }}",
              "duration_sec": "={{ $json.duration_sec }}",
              "session_count": "={{ $json.session_count }}",
              "session_rule": "={{ $json.session_rule }}",
              "max_gap_minutes": "={{ $json.max_gap_minutes }}",
              "msg_count_total": "={{ $json.msg_count_total }}",
              "msg_count_ai": "={{ $json.msg_count_ai }}",
              "msg_count_human": "={{ $json.msg_count_human }}",
              "turn_count": "={{ $json.turn_count }}",
              "intent_principal": "={{ $json.intent_principal }}",
              "intents_secundarios": "={{ $json.intents_secundarios }}",
              "resolution_status": "={{ $json.resolution_status }}",
              "no_resolution_reason": "={{ $json.no_resolution_reason }}",
              "reserva_accion": "={{ $json.reserva_accion }}",
              "reserva_codigo": "={{ $json.reserva_codigo }}",
              "reserva_fecha": "={{ $json.reserva_fecha }}",
              "reserva_hora": "={{ $json.reserva_hora }}",
              "reserva_pax": "={{ $json.reserva_pax }}",
              "reserva_zona": "={{ $json.reserva_zona }}",
              "cliente_nombre": "={{ $json.cliente_nombre }}",
              "repreguntas_count": "={{ $json.repreguntas_count }}",
              "claridad_siguiente_paso": "={{ $json.claridad_siguiente_paso }}",
              "friccion_score": "={{ $json.friccion_score }}",
              "sentiment_inicio": "={{ $json.sentiment_inicio }}",
              "sentiment_final": "={{ $json.sentiment_final }}",
              "tono_ai": "={{ $json.tono_ai }}",
              "escalacion_tipo": "={{ $json.escalacion_tipo }}",
              "escalacion_turno": "={{ $json.escalacion_turno }}",
              "handoff_quality": "={{ $json.handoff_quality }}",
              "error_tipo": "={{ $json.error_tipo }}",
              "riesgo_negocio": "={{ $json.riesgo_negocio }}",
              "improvement_tag": "={{ $json.improvement_tag }}",
              "evidence_message_ids": "={{ $json.evidence_message_ids }}",
              "evidence_snippet": "={{ $json.evidence_snippet }}",
              "datos_faltantes": "={{ $json.datos_faltantes }}",
              "entidades_json": "={{ $json.entidades_json }}",
              "messages_json": "={{ { \"conversacion\": $('Aggregate').item.json.data } }}",
              "analyzed_by": "={{ $json.analyzed_by }}",
              "analyzed_at": "={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat(\"yyyy-MM-dd'T'HH:mm:ss.000'Z'\") }}",
              "mes_analisis": "={{ $('Initial Data').first().json.mes_anterior }}",
              "session_id": "={{ $('Loop Over Items').item.json.session_id }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "audit_id",
                "displayName": "audit_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "session_id",
                "displayName": "session_id",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "channel",
                "displayName": "channel",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "agent",
                "displayName": "agent",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "brand",
                "displayName": "brand",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "sucursal_detectada",
                "displayName": "sucursal_detectada",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "first_user_ts",
                "displayName": "first_user_ts",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "last_user_ts",
                "displayName": "last_user_ts",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "duration_sec",
                "displayName": "duration_sec",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "session_count",
                "displayName": "session_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "session_rule",
                "displayName": "session_rule",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "max_gap_minutes",
                "displayName": "max_gap_minutes",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_total",
                "displayName": "msg_count_total",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_ai",
                "displayName": "msg_count_ai",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_human",
                "displayName": "msg_count_human",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "turn_count",
                "displayName": "turn_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "intent_principal",
                "displayName": "intent_principal",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "reservar",
                    "value": "reservar"
                  },
                  {
                    "name": "modificar_reserva",
                    "value": "modificar_reserva"
                  },
                  {
                    "name": "cancelar_reserva",
                    "value": "cancelar_reserva"
                  },
                  {
                    "name": "consultar_disponibilidad",
                    "value": "consultar_disponibilidad"
                  },
                  {
                    "name": "consultar_horarios",
                    "value": "consultar_horarios"
                  },
                  {
                    "name": "consultar_ubicacion",
                    "value": "consultar_ubicacion"
                  },
                  {
                    "name": "consultar_menu",
                    "value": "consultar_menu"
                  },
                  {
                    "name": "consultar_promociones",
                    "value": "consultar_promociones"
                  },
                  {
                    "name": "otro",
                    "value": "otro"
                  }
                ]
              },
              {
                "id": "intents_secundarios",
                "displayName": "intents_secundarios",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "resolution_status",
                "displayName": "resolution_status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "reservado",
                    "value": "reservado"
                  },
                  {
                    "name": "modificado",
                    "value": "modificado"
                  },
                  {
                    "name": "cancelado",
                    "value": "cancelado"
                  },
                  {
                    "name": "informacion_entregada",
                    "value": "informacion_entregada"
                  },
                  {
                    "name": "derivado_humano",
                    "value": "derivado_humano"
                  },
                  {
                    "name": "abandonado",
                    "value": "abandonado"
                  },
                  {
                    "name": "fallido",
                    "value": "fallido"
                  }
                ]
              },
              {
                "id": "resolution_ok",
                "displayName": "resolution_ok",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "no_resolution_reason",
                "displayName": "no_resolution_reason",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "faltan_datos_cliente",
                    "value": "faltan_datos_cliente"
                  },
                  {
                    "name": "faltan_datos_negocio",
                    "value": "faltan_datos_negocio"
                  },
                  {
                    "name": "error_herramienta",
                    "value": "error_herramienta"
                  },
                  {
                    "name": "politica_negocio",
                    "value": "politica_negocio"
                  },
                  {
                    "name": "loop_o_confusion",
                    "value": "loop_o_confusion"
                  },
                  {
                    "name": "cliente_no_responde",
                    "value": "cliente_no_responde"
                  },
                  {
                    "name": "otro",
                    "value": "otro"
                  }
                ]
              },
              {
                "id": "reserva_accion",
                "displayName": "reserva_accion",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "reserva_codigo",
                "displayName": "reserva_codigo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "reserva_fecha",
                "displayName": "reserva_fecha",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "reserva_hora",
                "displayName": "reserva_hora",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "time",
                "canBeUsedToMatch": true
              },
              {
                "id": "reserva_pax",
                "displayName": "reserva_pax",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "reserva_zona",
                "displayName": "reserva_zona",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "cliente_nombre",
                "displayName": "cliente_nombre",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "confirmacion_explicita",
                "displayName": "confirmacion_explicita",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "repreguntas_count",
                "displayName": "repreguntas_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "claridad_siguiente_paso",
                "displayName": "claridad_siguiente_paso",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "consistencia_sucursal",
                "displayName": "consistencia_sucursal",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "friccion_score",
                "displayName": "friccion_score",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "sentiment_inicio",
                "displayName": "sentiment_inicio",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "positivo",
                    "value": "positivo"
                  },
                  {
                    "name": "neutral",
                    "value": "neutral"
                  },
                  {
                    "name": "negativo",
                    "value": "negativo"
                  },
                  {
                    "name": "mixto",
                    "value": "mixto"
                  },
                  {
                    "name": "desconocido",
                    "value": "desconocido"
                  }
                ]
              },
              {
                "id": "sentiment_final",
                "displayName": "sentiment_final",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "positivo",
                    "value": "positivo"
                  },
                  {
                    "name": "neutral",
                    "value": "neutral"
                  },
                  {
                    "name": "negativo",
                    "value": "negativo"
                  },
                  {
                    "name": "mixto",
                    "value": "mixto"
                  },
                  {
                    "name": "desconocido",
                    "value": "desconocido"
                  }
                ]
              },
              {
                "id": "tono_ai",
                "displayName": "tono_ai",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalado",
                "displayName": "escalado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalacion_tipo",
                "displayName": "escalacion_tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalacion_turno",
                "displayName": "escalacion_turno",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "handoff_quality",
                "displayName": "handoff_quality",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "afirmacion_disponibilidad_sin_fuente",
                "displayName": "afirmacion_disponibilidad_sin_fuente",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "error_detectado",
                "displayName": "error_detectado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "error_tipo",
                "displayName": "error_tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "riesgo_negocio",
                "displayName": "riesgo_negocio",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "low",
                    "value": "low"
                  },
                  {
                    "name": "med",
                    "value": "med"
                  },
                  {
                    "name": "high",
                    "value": "high"
                  }
                ]
              },
              {
                "id": "improvement_tag",
                "displayName": "improvement_tag",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "options",
                "canBeUsedToMatch": true,
                "options": [
                  {
                    "name": "prompt",
                    "value": "prompt"
                  },
                  {
                    "name": "kb",
                    "value": "kb"
                  },
                  {
                    "name": "flujo_preguntas",
                    "value": "flujo_preguntas"
                  },
                  {
                    "name": "validaciones_fecha_hora",
                    "value": "validaciones_fecha_hora"
                  },
                  {
                    "name": "integracion_calendario",
                    "value": "integracion_calendario"
                  },
                  {
                    "name": "multi_sucursal",
                    "value": "multi_sucursal"
                  },
                  {
                    "name": "tono",
                    "value": "tono"
                  },
                  {
                    "name": "seguridad_privacidad",
                    "value": "seguridad_privacidad"
                  },
                  {
                    "name": "handoff_humano",
                    "value": "handoff_humano"
                  },
                  {
                    "name": "otro",
                    "value": "otro"
                  }
                ]
              },
              {
                "id": "evidence_message_ids",
                "displayName": "evidence_message_ids",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "evidence_snippet",
                "displayName": "evidence_snippet",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "datos_faltantes",
                "displayName": "datos_faltantes",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "entidades_json",
                "displayName": "entidades_json",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              },
              {
                "id": "messages_json",
                "displayName": "messages_json",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              },
              {
                "id": "analyzed_by",
                "displayName": "analyzed_by",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "analyzed_at",
                "displayName": "analyzed_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "mes_analisis",
                "displayName": "mes_analisis",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          400,
          208
        ],
        "id": "00448d34-2ac5-44dc-9f5c-2b044f834559",
        "name": "Registra Analisis",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -1024,
          256
        ],
        "id": "16342940-c9a2-4609-bb5a-88b5902f1fd1",
        "name": "Loop Over Items"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          720,
          304
        ],
        "id": "1f79f4d8-c8d5-4ed9-894d-de5e03c2e877",
        "name": "Wait",
        "webhookId": "dee12afd-228b-4800-ab81-8167794d8844"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          720,
          704
        ],
        "id": "46f6c52f-ef35-4363-bd41-a44608004693",
        "name": "Wait1",
        "webhookId": "dee12afd-228b-4800-ab81-8167794d8844"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          -176,
          1200
        ],
        "id": "5b275b2a-d468-474d-a04d-39b8a39233ff",
        "name": "Google Gemini Chat Model2",
        "credentials": {
          "googlePalmApi": {
            "id": "OAlDnAQJQHCtNBVS",
            "name": "Google Gemini(PaLM) Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          720,
          1152
        ],
        "id": "13dd9e18-afc4-4fec-8558-79356f0251c0",
        "name": "Wait2",
        "webhookId": "dee12afd-228b-4800-ab81-8167794d8844"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "\nSELECT DISTINCT ch.session_id\n       --ch.ultimos_10_numeros\nFROM (\n    SELECT session_id,\n           RIGHT(SPLIT_PART(session_id, '@', 1), 10) as ultimos_10_numeros\n    FROM (\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_47\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n        UNION\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_47_bkup\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n    ) t\n) ch\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM osaki_analytics.auditoria_conversacion_delivery a\n    WHERE a.session_id = ch.session_id\n    AND a.mes_analisis = '{{ $json.mes_anterior }}'\n    and sucursal_detectada = 'Calle 47'\n)\nAND NOT EXISTS (\n    SELECT 1\n    FROM osaki_main.blacklist_phones_calle_47 b\n    WHERE b.phone = ch.ultimos_10_numeros::bigint\n)\nORDER BY ch.session_id ASC;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -1264,
          656
        ],
        "id": "4e0f21e5-df98-457a-9a47-b4ac873707ee",
        "name": "Get Session_Ids_Delivery_47",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -1024,
          656
        ],
        "id": "a31e5478-6df7-4d19-9883-5fd4f3f0037f",
        "name": "Loop Over Items_Delivery_47"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "WITH raw_messages AS (\n    -- Paso 1: Obtenemos los últimos 10 registros de la tabla principal\n    SELECT \n        id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'main' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_47\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n    UNION \n    -- Paso 2: Obtenemos los últimos 10 registros del backup\n    SELECT \n        old_id as id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'backup' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_47_bkup\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n  ),\ncleaned_content AS (\n    -- Paso 3: Limpiamos el ruido inicial (ej: [Used tools...]) una sola vez\n    SELECT \n        id,\n        type,\n        regexp_replace(raw_content, '^\\[Used tools:.*\\]\\]\\s*', '') AS content\n    FROM raw_messages\n)\n-- Paso 4: Aplicamos la lógica de extracción de fecha y texto final\nSELECT\n    CASE \n        WHEN type = 'human' THEN \n            to_char(\n                to_timestamp(\n                    -- Extraemos la fecha y normalizamos guiones a barras\n                    replace(\n                        substring(content FROM '(?i)fecha\\s*y\\s*hora:\\s*([0-9]{4}[/-][0-9]{2}[/-][0-9]{2}\\s*[0-9]{2}:[0-9]{2}:[0-9]{2})'),\n                        '-', '/'\n                    ), \n                    'YYYY/MM/DD HH24:MI:SS'\n                ), \n                'YYYY/MM/DD HH24:MI:SS'\n            )\n        ELSE NULL \n    END AS fecha_hora,\n    \n    id,\n    type,\n    \n    CASE \n        WHEN type = 'human' THEN \n            trim(\n                regexp_replace(\n                    split_part(content, 'Mensaje de Texto o Descripción:', 2),\n                    '\\s+', ' ', 'g'\n                )\n            )\n        ELSE content \n    END AS content\nFROM cleaned_content\nORDER BY id asc;\n",
          "options": {
            "queryReplacement": "={{ $json.session_id }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -544,
          576
        ],
        "id": "2ff80863-a3b0-41d1-9779-5925c1464080",
        "name": "Get Conversation_Delivery_47",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -336,
          576
        ],
        "id": "defc7063-7ff7-4410-9620-e6d7a17f53dc",
        "name": "Aggregate_Delivery_47"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ JSON.stringify({\n  conversation_id: $('Loop Over Items_Delivery_47').item.json.session_id ,\n  messages: $input.all().map(i => i.json)\n}) }}\n",
          "needsFallback": true,
          "options": {
            "systemMessage": "=ROL\nEres un auditor automático de conversaciones (WhatsApp u otros canales) para un agente de DELIVERY / SEGUIMIENTO DE PEDIDOS.\nTu tarea es analizar una conversación (lista de mensajes) y producir UN ÚNICO JSON con las columnas de la tabla\nosaki_analytics.auditoria_conversacion_delivery.\n\nREGLA CRÍTICA ANTI-ALUCINACIÓN (OBLIGATORIA)\n- Solo puedes afirmar datos explícitos en los mensajes de entrada.\n- Si un dato no aparece o no puede inferirse de forma determinística, usa null (o [] para arreglos) y agrega el nombre del campo a datos_faltantes.\n- No inventes: estado del pedido, ETA/tiempo de entrega, consultas a herramientas/DB, políticas, identidades, ni acciones fuera del texto.\n- Si el bot afirma “tu pedido está en camino / en preparación / llega en X min” y NO existe evidencia en el input de que consultó una herramienta/DB (o que se mostró un resultado explícito),\n  entonces:\n  - afirmacion_estado_sin_fuente = true (si afirma estado)\n  - afirmacion_eta_sin_fuente = true (si afirma ETA/tiempo)\n  - y NO uses ese estado/ETA como verdad: deja pedido_estado=\"desconocido\" y/o pedido_hora=null.\n\nINPUT (FORMATO)\nRecibirás un único JSON con:\n- conversation_id: string\n- (opcional) channel: string\n- (opcional) agent: string\n- (opcional) brand: string\n- messages: array de objetos con:\n  - id: number|string|null\n  - fecha_hora: string|null\n  - type: \"human\" | \"ai\" | \"human_agent\" | otro\n  - content: string\n\nDEFAULTS (solo si NO vienen en input)\n- channel = \"whatsapp\"\n- agent = \"delivery\"\n- brand = null\n\nREGLAS DE CÁLCULO\n\n1) Tiempo y sesiones\n- Parsear timestamps no nulos (si no parsea, tratar como null).\n- first_user_ts: primer timestamp de type='human'\n- last_user_ts: último timestamp de type='human'\n- duration_sec: last_user_ts - first_user_ts (segundos) si ambos existen; si no, null.\n- session_rule (texto fijo): \"gap_human_gt_30m\"\n- session_count: 1 + número de gaps entre mensajes 'human' consecutivos > 30 min. Si no hay ts suficientes, 1.\n- max_gap_minutes: máximo gap (min) entre mensajes 'human' consecutivos. Si no hay ts suficientes, null.\n\n2) Conteos\n- msg_count_total: total mensajes\n- msg_count_ai: count(type='ai')\n- msg_count_human: count(type='human') + count(type='human_agent')\n- turn_count: número de cambios de actor al recorrer mensajes en orden temporal (cada cambio incrementa turno).\n  Si no hay timestamps, usa el orden dado.\n\n3) Intención (texto libre con catálogo recomendado)\nintent_principal: elige 1 (texto). Catálogo recomendado:\n- crear_pedido -> nuevo pedido\n- rastrear_pedido -> estado/ubicación/ETA del pedido\n- modificar_pedido -> cambio en pedido existente\n- cancelar_pedido -> anular pedido existente\n- consultar_menu -> info sobre menú/productos\n- consultar_promociones -> info sobre ofertas/descuentos\n- consultar_horarios -> info sobre horarios de atención\n- consultar_ubicacion -> info sobre dirección/sucursales\n- reservacion_mesa -> reservar mesa en restaurante\n- seguimiento_pedido -> Realizar el seguimiento de un pedido\n- notificacion_pedido -> Notificación del estado de un pedido\n- otro -> no encaja\n- Si no hay intención clara o es ambigua => \"otro\".\n\nintents_secundarios: arreglo de strings (sin duplicar intent_principal). Si no hay, [].\n\n4) Resolución\n- resolution_ok: true si el intent_principal fue exitoso;\n  false si no se logró o quedó inconcluso.\n- resolution_status (texto recomendado):\n  - \"exitoso\" -> si se logró la acción principal (pedido creado/modificado/cancelado o info entregada y humano cierra conforme)\n  - \"parcial\" -> si se logró parcialmente (p.ej. pedido modificado parcialmente)\n  - \"fallido\" -> si no se logró la acción principal\n  - \"derivado_humano\" -> si escaló a humano antes de resolución\n  - \"abandonado\" -> si el humano cierra sin resolución\n  - \"otro\"\n- no_resolution_reason (texto, solo si resolution_ok=false). Catálogo recomendado:\n  - \"faltan_datos_cliente\" -> faltan datos del cliente (nombre, código, etc.)\n  - \"faltan_datos_negocio\" -> faltan datos del negocio (disponibilidad, tiempos, etc.)\n  - \"error_herramienta\" -> error técnico o de integración\n  - \"politica_negocio\" -> política que impide completar acción\n  - \"loop_o_confusion\" -> bucle o confusión en la conversación\n  - \"cliente_no_responde\" -> el cliente no responde o cierra\n  - \"otro\"\n  - null si resolution_ok=true\nSi resolution_ok=true => no_resolution_reason=null y resolution_status NO debe ser \"fallido\".\n\n5) Extracción de entidades (solo si aparecen explícitas)\n- pedido_accion (texto recomendado):\n  - \"create\" | \"track\" | \"modify\" | \"cancel\" | null\n- pedido_codigo: string|null (código/ID explícito)\n- pedido_plataforma (texto recomendado):\n  - \"masdelivery\" | \"pedidosya\" | \"web\" | \"whatsapp\" | \"desconocido\"\n- pedido_tipo_entrega: \"delivery\" | \"retiro\" | null (solo si lo dicen)\n- pedido_estado: texto recomendado:\n  - \"recibido\" | \"en_preparacion\" | \"listo\" | \"en_viaje\" | \"entregado\" | \"cancelado\" | \"desconocido\"\n  Reglas:\n  - Solo usar un estado como verdad si aparece explícito con certeza en el chat (por usuario/humano o por resultado explícito).\n  - Si el AI lo afirma sin fuente: pedido_estado=\"desconocido\" y afirmacion_estado_sin_fuente=true.\n- pedido_fecha: \"YYYY-MM-DD\"|null (si se menciona con certeza)\n- pedido_hora: \"HH:MM\"|\"HH:MM:SS\"|null (si se menciona con certeza)\n- cliente_nombre: string|null (si lo aporta explícitamente)\n- sucursal_detectada: string|null (si se menciona explícitamente)\n\n6) Calidad del flujo\n- confirmacion_explicita:\n  true si existe confirmación explícita de cualquiera de las partes sobre un dato/acción (p.ej. “confirmo”, “ok”, “sí” ante una propuesta concreta).\n- repreguntas_count:\n  cuántas veces la IA pide un dato ya entregado por el humano (código, nombre, plataforma, etc.)\n- claridad_siguiente_paso: 0|1|2\n  - 2: siguiente paso concreto y accionable\n  - 1: hay siguiente paso pero incompleto/ambiguo\n  - 0: no hay\n- friccion_score: 0..5 (enteros)\n  Suma sugerida (cap a 5):\n  +2 queja/enojo (“mal”, “tardan”, insultos)\n  +1 si la IA comete error evidente (fecha/hora/política)\n  +1 confusión (“no entiendo”, “cómo”, “qué hago”)\n  +1 repetición del mismo pedido sin avance\n  +1 conversación larga sin progreso\n- consistencia_sucursal:\n  true si no hay contradicción en sucursal; false si cambia; null si no se menciona.\n\n7) Sentimiento (texto libre con catálogo recomendado)\nsentiment_inicio y sentiment_final (texto recomendado):\n- \"positivo\" | \"neutral\" | \"negativo\" | \"mixto\" | \"desconocido\"\n\n8) Escalación\n- escalado: true si se indica explícitamente que un humano continuará (“te escribe alguien”, “paso a un compañero”, etc.)\n- escalacion_tipo (texto recomendado): \n  \"politica\" | \"incertidumbre\" | \"error_tecnico\" | \"queja\" | \"peticion_cliente\" | \"loop_conversacional\" | \"otro\" | null\n- escalacion_turno: integer|null (turno donde ocurre primera mención de escalación)\n- handoff_quality: 0|1|2|null\n  - 2: resumen + datos clave + siguiente paso claro\n  - 1: parcial\n  - 0: sin contexto\nRegla:\n- Si escalado=false => escalacion_tipo=null, escalacion_turno=null, handoff_quality=null.\n\n9) Veracidad / errores\n- error_detectado: true SOLO si hay evidencia clara de error/bucle/contradicción.\n- error_tipo (texto recomendado):\n  \"invento_info\" | \"estado_inventado\" | \"eta_inventado\" | \"politica_mal_aplicada\" | \"contradiccion\" | \"loop\" | \"otro\" | null\n\n10) Riesgo / mejoras (texto libre)\n- riesgo_negocio: \"low\" | \"med\" | \"high\" (recomendado)\n- improvement_tag: string|null (texto libre; usa tags consistentes, p.ej. \"kb\", \"flujo_preguntas\", \"handoff_humano\", etc.)\n\n11) Evidencia\n- evidence_message_ids:\n  lista de 2 a 6 ids que sustenten intent, resolución, escalación o error. Si no hay ids, [].\nRegla:\n- Si resolution_ok=true o escalado=true o error_detectado=true => evidence_message_ids NO debe ser [].\n- evidence_snippet:\n  1-2 líneas <= 250 caracteres con extracto mínimo (sin inventar).\n- datos_faltantes:\n  arreglo de strings con campos relevantes que quedaron null/[] por falta de evidencia.\n\n12) entidades_json (jsonb)\nEstructura mínima:\n{\n  \"extracted\": { ... },\n  \"confidence\": { \"campo\": 0.0-1.0, ... },\n  \"notes\": [ ... ]\n}\n\nSALIDA (FORMATO ESTRICTO)\nResponde EXCLUSIVAMENTE con UN ÚNICO JSON válido, sin markdown, sin comentarios, sin texto adicional.\nLas claves deben coincidir EXACTAMENTE con las columnas de osaki_analytics.auditoria_conversacion_delivery:\n\n```json\n{\n  \"conversation_id\": \"string\",\n  \"channel\": \"string\",\n  \"agent\": \"string\",\n  \"brand\": \"string|null\",\n  \"sucursal_detectada\": \"string|null\",\n\n  \"first_user_ts\": \"timestamp|null\",  // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"last_user_ts\": \"timestamp|null\",   // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"duration_sec\": \"number|null\", // número entero >=0\n\n  \"session_count\": 1, // número de sesiones detectadas\n  \"session_rule\": \"gap_human_gt_30m\", \n  \"max_gap_minutes\": \"number|null\", // número entero >=0\n\n  \"msg_count_total\": 0, // número de mensajes en total\n  \"msg_count_ai\": 0, // número de mensajes del AI\n  \"msg_count_human\": 0, // número de mensajes del humano\n  \"turn_count\": 0,  // min(msg_count_human, msg_count_ai)\n\n  \"intent_principal\": \"crear_pedido|rastrear_pedido|modificar_pedido|cancelar_pedido|consultar_menu|consultar_promociones|consultar_horarios|consultar_ubicacion|reservacion_mesa|seguimiento_pedido|notificacion_pedido|otro\",  //  ENUM ¿Cuál es el objetivo dominante del humano?\n  \"intents_secundarios\": [],  // arreglo de strings (sin duplicar intent_principal). Si no hay, []\n\n  \"resolution_status\": \"exitoso|parcial|fallido|derivado_humano|abandonado|otro\", // estado de resolución del intent principal\n  \"resolution_ok\": \"true|false\", // boolean, si el intento principal se logró\n  \"no_resolution_reason\": \"faltan_datos_cliente|faltan_datos_negocio|error_herramienta|politica_negocio|loop_o_confusion|cliente_no_responde|otro|null\", // null si resolution_ok es true\n\n  \"pedido_accion\": \"create|track|modify|cancel|null\", // Si hay un pedido explícito\n  \"pedido_codigo\": \"string|null\",\n  \"pedido_plataforma\": \"masdelivery|pedidosya|web|whatsapp|desconocido\",\n  \"pedido_tipo_entrega\": \"delivery|retiro|null\",\n  \"pedido_estado\": \"string\",\n  \"pedido_fecha\": \"YYYY-MM-DD|null\",\n  \"pedido_hora\": \"HH:MM|HH:MM:SS|null\",\n\n  \"cliente_nombre\": \"string|null\",\n\n  \"confirmacion_explicita\": \"true|false\", // boolean si la IA pide confirmación explícita\n  \"repreguntas_count\": 0, // número de repreguntas sobre datos ya dados\n  \"claridad_siguiente_paso\": \"0|1|2\",  // 0: no hay; 1: ambiguo/incompleto; 2: claro\n  \"consistencia_sucursal\": \"true|false|null\", // null si no se menciona\n  \"friccion_score\": \"0|1|2|3|4|5|6\", // 0 (sin fricción) a 6 (mucha fricción)\n\n  \"sentiment_inicio\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al inicio de la conversación\n  \"sentiment_final\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al final de la conversación\n  \"tono_ai\": \"cordial|profesional|efusivo|otro\", // etiqueta breve según estilo del bot\n\n  \"escalado\": \"true|false\", // boolean si hubo escalación a humano\n  \"escalacion_tipo\": \"politica|incertidumbre|error_tecnico|queja|peticion_cliente|loop_conversacional|otro|null\", // null si escalado es false\n  \"escalacion_turno\": \"number|null\", //  null si escalado es false\n  \"handoff_quality\": \"number|null\",\n\n  \"afirmacion_estado_sin_fuente\": \"true|false\", // boolean si el bot afirma estado sin evidencia de consulta a herramienta\n  \"afirmacion_eta_sin_fuente\": \"true|false\", // boolean si el bot afirma ETA sin evidencia de consulta a herramienta\n\n  \"error_detectado\": \"true|false\", // boolean si hay evidencia interna de error/contradicción por parte de la IA\n  \"error_tipo\": \"invento_info|estado_inventado|eta_inventado|politica_mal_aplicada|contradiccion|loop|otro|null\", // null si error_detectado es false\n\n  \"riesgo_negocio\": \"high|med|low\", // nivel de riesgo detectado\n  \"improvement_tag\": \"prompt|kb|flujo_preguntas|validaciones_fecha_hora|integracion_calendario|multi_sucursal|tono|seguridad_privacidad|handoff_humano|otro|null\", // null si no aplica\n\n  \"evidence_message_ids\": [],\n  \"evidence_snippet\": \"string|null\",\n  \"datos_faltantes\": [],\n\n  \"entidades_json\": { \"extracted\": {}, \"confidence\": {}, \"notes\": [] },\n  \"messages_json\": null,\n\n  \"analyzed_by\": \"audit-llm-delivery-v1\"\n}\n```\n\nVALIDACIONES FINALES (OBLIGATORIAS)\n- No “rellenes” con suposiciones: si falta evidencia => null/[] + datos_faltantes.\n- Si resolution_ok=true => resolution_status != \"fallido\" y no_resolution_reason=null.\n- Si escalado=false => escalacion_* = null y handoff_quality=null.\n- Si (resolution_ok=true) OR (escalado=true) OR (error_detectado=true) => evidence_message_ids no puede ser [].\n- Usa español.\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3,
        "position": [
          -144,
          576
        ],
        "id": "87794200-9c56-40ed-8ebb-a3f2cbb7a532",
        "name": "AI Agent_Delivery_47"
      },
      {
        "parameters": {
          "jsCode": "// Iteramos sobre todos los items\nreturn items.map(item => {\n  try {\n    // 1. Obtenemos el string\n    let rawContent = item.json.output || \"\";\n\n    // 2. Limpieza de Markdown (Como antes)\n    let cleanContent = rawContent\n      .replace(/^```json\\s*/i, '')\n      .replace(/^```\\s*/i, '')\n      .replace(/\\s*```$/, '')\n      .trim();\n\n    // -----------------------------------------------------------\n    // 3. REPARACIÓN DE JSON ROTO (El Parche)\n    // -----------------------------------------------------------\n    // El error es: cierra una propiedad con \", en lugar de },\n    // Buscamos: Salto de linea (\\n) -> Espacios (\\s*) -> Comilla (\") -> Coma (,)\n    // Y lo reemplazamos por: },\n    // Nota: Usamos una Regex específica para no romper otros textos.\n    \n    cleanContent = cleanContent.replace(/(\\n\\s*)\"\\s*,/g, '$1},');\n\n    // -----------------------------------------------------------\n\n    // 4. Parseo\n    const parsedData = JSON.parse(cleanContent);\n\n    // 5. Retorno Exitoso\n    return {\n      json: parsedData\n    };\n\n  } catch (error) {\n    // Si falla de nuevo, te dará detalles más precisos\n    return {\n      json: {\n        error: true,\n        message: \"Aún fallando el parseo. Revisa 'cleaned_string' para ver el error.\",\n        original_error: error.message,\n        // Devolvemos el string limpio para que veas si el parche funcionó visualmente\n        cleaned_string: error.input_string_debug \n      }\n    };\n  }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          176,
          576
        ],
        "id": "982df9e6-d96a-4c89-b820-01869ffa687d",
        "name": "Normaliza Salida_Delivery_47"
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "value": "osaki_analytics",
            "mode": "list",
            "cachedResultName": "osaki_analytics"
          },
          "table": {
            "__rl": true,
            "value": "auditoria_conversacion_delivery",
            "mode": "list",
            "cachedResultName": "auditoria_conversacion_delivery"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "resolution_ok": "={{ $json.resolution_ok }}",
              "confirmacion_explicita": "={{ $json.confirmacion_explicita }}",
              "consistencia_sucursal": "={{ $json.consistencia_sucursal }}",
              "escalado": "={{ $json.escalado }}",
              "afirmacion_estado_sin_fuente": "={{ $json.afirmacion_estado_sin_fuente }}",
              "afirmacion_eta_sin_fuente": "={{ $json.afirmacion_eta_sin_fuente }}",
              "error_detectado": "={{ $json.error_detectado }}",
              "channel": "WhatsApp",
              "agent": "Delivery",
              "brand": "Osaki",
              "sucursal_detectada": "Calle 47",
              "first_user_ts": "={{ $json.first_user_ts }}",
              "last_user_ts": "={{ $json.last_user_ts }}",
              "duration_sec": "={{ $json.duration_sec }}",
              "session_count": "={{ $json.session_count }}",
              "session_rule": "={{ $json.session_rule }}",
              "max_gap_minutes": "={{ $json.max_gap_minutes }}",
              "msg_count_total": "={{ $json.msg_count_total }}",
              "msg_count_ai": "={{ $json.msg_count_ai }}",
              "msg_count_human": "={{ $json.msg_count_human }}",
              "turn_count": "={{ $json.turn_count }}",
              "intent_principal": "={{ $json.intent_principal }}",
              "intents_secundarios": "={{ $json.intents_secundarios }}",
              "resolution_status": "={{ $json.resolution_status }}",
              "no_resolution_reason": "={{ $json.no_resolution_reason }}",
              "pedido_accion": "={{ $json.pedido_accion }}",
              "pedido_codigo": "={{ $json.pedido_codigo }}",
              "pedido_plataforma": "={{ $json.pedido_plataforma }}",
              "pedido_tipo_entrega": "={{ $json.pedido_tipo_entrega }}",
              "pedido_estado": "={{ $json.pedido_estado }}",
              "pedido_fecha": "={{ $json.pedido_fecha }}",
              "pedido_hora": "={{ $json.pedido_hora }}",
              "cliente_nombre": "={{ $json.cliente_nombre }}",
              "repreguntas_count": "={{ $json.repreguntas_count }}",
              "claridad_siguiente_paso": "={{ $json.claridad_siguiente_paso }}",
              "friccion_score": "={{ $json.friccion_score }}",
              "sentiment_inicio": "={{ $json.sentiment_inicio }}",
              "sentiment_final": "={{ $json.sentiment_final }}",
              "tono_ai": "={{ $json.tono_ai }}",
              "escalacion_tipo": "={{ $json.escalacion_tipo }}",
              "escalacion_turno": "={{ $json.escalacion_turno }}",
              "handoff_quality": "={{ $json.handoff_quality }}",
              "error_tipo": "={{ $json.error_tipo }}",
              "riesgo_negocio": "={{ $json.riesgo_negocio }}",
              "improvement_tag": "={{ $json.improvement_tag }}",
              "evidence_message_ids": "={{ $json.evidence_message_ids }}",
              "evidence_snippet": "={{ $json.evidence_snippet }}",
              "datos_faltantes": "={{ $json.datos_faltantes }}",
              "entidades_json": "={{ $json.entidades_json }}",
              "analyzed_by": "={{ $json.analyzed_by }}",
              "messages_json": "={{ { \"conversacion\": $('Aggregate_Delivery_47').item.json.data } }}",
              "analyzed_at": "={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat(\"yyyy-MM-dd'T'HH:mm:ss.000'Z'\") }}",
              "session_id": "={{ $('Loop Over Items_Delivery_47').item.json.session_id }}",
              "mes_analisis": "={{ $('Initial Data').first().json.mes_anterior }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "audit_id",
                "displayName": "audit_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "session_id",
                "displayName": "session_id",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "channel",
                "displayName": "channel",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "agent",
                "displayName": "agent",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "brand",
                "displayName": "brand",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "sucursal_detectada",
                "displayName": "sucursal_detectada",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "first_user_ts",
                "displayName": "first_user_ts",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "last_user_ts",
                "displayName": "last_user_ts",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "duration_sec",
                "displayName": "duration_sec",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "session_count",
                "displayName": "session_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "session_rule",
                "displayName": "session_rule",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "max_gap_minutes",
                "displayName": "max_gap_minutes",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_total",
                "displayName": "msg_count_total",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_ai",
                "displayName": "msg_count_ai",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_human",
                "displayName": "msg_count_human",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "turn_count",
                "displayName": "turn_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "intent_principal",
                "displayName": "intent_principal",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "intents_secundarios",
                "displayName": "intents_secundarios",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "resolution_status",
                "displayName": "resolution_status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "resolution_ok",
                "displayName": "resolution_ok",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "no_resolution_reason",
                "displayName": "no_resolution_reason",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_accion",
                "displayName": "pedido_accion",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_codigo",
                "displayName": "pedido_codigo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_plataforma",
                "displayName": "pedido_plataforma",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_tipo_entrega",
                "displayName": "pedido_tipo_entrega",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_estado",
                "displayName": "pedido_estado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_fecha",
                "displayName": "pedido_fecha",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_hora",
                "displayName": "pedido_hora",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "time",
                "canBeUsedToMatch": true
              },
              {
                "id": "cliente_nombre",
                "displayName": "cliente_nombre",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "confirmacion_explicita",
                "displayName": "confirmacion_explicita",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "repreguntas_count",
                "displayName": "repreguntas_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "claridad_siguiente_paso",
                "displayName": "claridad_siguiente_paso",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "consistencia_sucursal",
                "displayName": "consistencia_sucursal",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "friccion_score",
                "displayName": "friccion_score",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "sentiment_inicio",
                "displayName": "sentiment_inicio",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "sentiment_final",
                "displayName": "sentiment_final",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "tono_ai",
                "displayName": "tono_ai",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalado",
                "displayName": "escalado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalacion_tipo",
                "displayName": "escalacion_tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalacion_turno",
                "displayName": "escalacion_turno",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "handoff_quality",
                "displayName": "handoff_quality",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "afirmacion_estado_sin_fuente",
                "displayName": "afirmacion_estado_sin_fuente",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "afirmacion_eta_sin_fuente",
                "displayName": "afirmacion_eta_sin_fuente",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "error_detectado",
                "displayName": "error_detectado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "error_tipo",
                "displayName": "error_tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "riesgo_negocio",
                "displayName": "riesgo_negocio",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "improvement_tag",
                "displayName": "improvement_tag",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "evidence_message_ids",
                "displayName": "evidence_message_ids",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "evidence_snippet",
                "displayName": "evidence_snippet",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "datos_faltantes",
                "displayName": "datos_faltantes",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "entidades_json",
                "displayName": "entidades_json",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              },
              {
                "id": "messages_json",
                "displayName": "messages_json",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              },
              {
                "id": "analyzed_by",
                "displayName": "analyzed_by",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "analyzed_at",
                "displayName": "analyzed_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "mes_analisis",
                "displayName": "mes_analisis",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          400,
          576
        ],
        "id": "3bb68151-212b-4354-aef0-3034d2d6db5b",
        "name": "Registra Analisis_Delivery_47",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "\nSELECT DISTINCT ch.session_id\n       --ch.ultimos_10_numeros\nFROM (\n    SELECT session_id,\n           RIGHT(SPLIT_PART(session_id, '@', 1), 10) as ultimos_10_numeros\n    FROM (\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_9\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n        UNION\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_9_bkup\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n    ) t\n) ch\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM osaki_analytics.auditoria_conversacion_delivery a\n    WHERE a.session_id = ch.session_id\n    AND a.mes_analisis = '{{ $json.mes_anterior }}'\n    and sucursal_detectada = 'Calle 9'\n)\nAND NOT EXISTS (\n    SELECT 1\n    FROM osaki_main.blacklist_phones_calle_9 b\n    WHERE b.phone = ch.ultimos_10_numeros::bigint\n)\nORDER BY ch.session_id ASC;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -1248,
          1104
        ],
        "id": "f49a3f51-a425-4b68-baf8-3f9c6ac1178f",
        "name": "Get Session_Ids_Delivery_9",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -1024,
          1104
        ],
        "id": "3997c204-010a-47d5-be2c-33f8575cc613",
        "name": "Loop Over Items_Delivery_9"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "WITH raw_messages AS (\n    -- Paso 1: Obtenemos los últimos 10 registros de la tabla principal\n    SELECT \n        id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'main' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_9\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n    UNION \n    -- Paso 2: Obtenemos los últimos 10 registros del backup\n    SELECT \n        old_id as id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'backup' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_9_bkup\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n  ),\ncleaned_content AS (\n    -- Paso 3: Limpiamos el ruido inicial (ej: [Used tools...]) una sola vez\n    SELECT \n        id,\n        type,\n        regexp_replace(raw_content, '^\\[Used tools:.*\\]\\]\\s*', '') AS content\n    FROM raw_messages\n)\n-- Paso 4: Aplicamos la lógica de extracción de fecha y texto final\nSELECT\n    CASE \n        WHEN type = 'human' THEN \n            to_char(\n                to_timestamp(\n                    -- Extraemos la fecha y normalizamos guiones a barras\n                    replace(\n                        substring(content FROM '(?i)fecha\\s*y\\s*hora:\\s*([0-9]{4}[/-][0-9]{2}[/-][0-9]{2}\\s*[0-9]{2}:[0-9]{2}:[0-9]{2})'),\n                        '-', '/'\n                    ), \n                    'YYYY/MM/DD HH24:MI:SS'\n                ), \n                'YYYY/MM/DD HH24:MI:SS'\n            )\n        ELSE NULL \n    END AS fecha_hora,\n    \n    id,\n    type,\n    \n    CASE \n        WHEN type = 'human' THEN \n            trim(\n                regexp_replace(\n                    split_part(content, 'Mensaje de Texto o Descripción:', 2),\n                    '\\s+', ' ', 'g'\n                )\n            )\n        ELSE content \n    END AS content\nFROM cleaned_content\nORDER BY id asc;\n",
          "options": {
            "queryReplacement": "={{ $json.session_id }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -544,
          1056
        ],
        "id": "08202f9c-1a48-4372-bba4-0d2907ef8d0d",
        "name": "Get Conversation_Delivery_9",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -336,
          1056
        ],
        "id": "ebb143a5-c553-4f18-882d-3594f036082a",
        "name": "Aggregate_Delivery_9"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ JSON.stringify({\n  conversation_id: $('Loop Over Items_Delivery_9').item.json.session_id ,\n  messages: $input.all().map(i => i.json)\n}) }}\n",
          "options": {
            "systemMessage": "=ROL\nEres un auditor automático de conversaciones (WhatsApp u otros canales) para un agente de DELIVERY / SEGUIMIENTO DE PEDIDOS.\nTu tarea es analizar una conversación (lista de mensajes) y producir UN ÚNICO JSON con las columnas de la tabla\nosaki_analytics.auditoria_conversacion_delivery.\n\nREGLA CRÍTICA ANTI-ALUCINACIÓN (OBLIGATORIA)\n- Solo puedes afirmar datos explícitos en los mensajes de entrada.\n- Si un dato no aparece o no puede inferirse de forma determinística, usa null (o [] para arreglos) y agrega el nombre del campo a datos_faltantes.\n- No inventes: estado del pedido, ETA/tiempo de entrega, consultas a herramientas/DB, políticas, identidades, ni acciones fuera del texto.\n- Si el bot afirma “tu pedido está en camino / en preparación / llega en X min” y NO existe evidencia en el input de que consultó una herramienta/DB (o que se mostró un resultado explícito),\n  entonces:\n  - afirmacion_estado_sin_fuente = true (si afirma estado)\n  - afirmacion_eta_sin_fuente = true (si afirma ETA/tiempo)\n  - y NO uses ese estado/ETA como verdad: deja pedido_estado=\"desconocido\" y/o pedido_hora=null.\n\nINPUT (FORMATO)\nRecibirás un único JSON con:\n- conversation_id: string\n- (opcional) channel: string\n- (opcional) agent: string\n- (opcional) brand: string\n- messages: array de objetos con:\n  - id: number|string|null\n  - fecha_hora: string|null\n  - type: \"human\" | \"ai\" | \"human_agent\" | otro\n  - content: string\n\nDEFAULTS (solo si NO vienen en input)\n- channel = \"whatsapp\"\n- agent = \"delivery\"\n- brand = null\n\nREGLAS DE CÁLCULO\n\n1) Tiempo y sesiones\n- Parsear timestamps no nulos (si no parsea, tratar como null).\n- first_user_ts: primer timestamp de type='human'\n- last_user_ts: último timestamp de type='human'\n- duration_sec: last_user_ts - first_user_ts (segundos) si ambos existen; si no, null.\n- session_rule (texto fijo): \"gap_human_gt_30m\"\n- session_count: 1 + número de gaps entre mensajes 'human' consecutivos > 30 min. Si no hay ts suficientes, 1.\n- max_gap_minutes: máximo gap (min) entre mensajes 'human' consecutivos. Si no hay ts suficientes, null.\n\n2) Conteos\n- msg_count_total: total mensajes\n- msg_count_ai: count(type='ai')\n- msg_count_human: count(type='human') + count(type='human_agent')\n- turn_count: número de cambios de actor al recorrer mensajes en orden temporal (cada cambio incrementa turno).\n  Si no hay timestamps, usa el orden dado.\n\n3) Intención (texto libre con catálogo recomendado)\nintent_principal: elige 1 (texto). Catálogo recomendado:\n- crear_pedido -> nuevo pedido\n- rastrear_pedido -> estado/ubicación/ETA del pedido\n- modificar_pedido -> cambio en pedido existente\n- cancelar_pedido -> anular pedido existente\n- consultar_menu -> info sobre menú/productos\n- consultar_promociones -> info sobre ofertas/descuentos\n- consultar_horarios -> info sobre horarios de atención\n- consultar_ubicacion -> info sobre dirección/sucursales\n- reservacion_mesa -> reservar mesa en restaurante\n- seguimiento_pedido -> Realizar el seguimiento de un pedido\n- notificacion_pedido -> Notificación del estado de un pedido\n- otro -> no encaja\n- Si no hay intención clara o es ambigua => \"otro\".\n\nintents_secundarios: arreglo de strings (sin duplicar intent_principal). Si no hay, [].\n\n4) Resolución\n- resolution_ok: true si el intent_principal fue exitoso;\n  false si no se logró o quedó inconcluso.\n- resolution_status (texto recomendado):\n  - \"exitoso\" -> si se logró la acción principal (pedido creado/modificado/cancelado o info entregada y humano cierra conforme)\n  - \"parcial\" -> si se logró parcialmente (p.ej. pedido modificado parcialmente)\n  - \"fallido\" -> si no se logró la acción principal\n  - \"derivado_humano\" -> si escaló a humano antes de resolución\n  - \"abandonado\" -> si el humano cierra sin resolución\n  - \"otro\"\n- no_resolution_reason (texto, solo si resolution_ok=false). Catálogo recomendado:\n  - \"faltan_datos_cliente\" -> faltan datos del cliente (nombre, código, etc.)\n  - \"faltan_datos_negocio\" -> faltan datos del negocio (disponibilidad, tiempos, etc.)\n  - \"error_herramienta\" -> error técnico o de integración\n  - \"politica_negocio\" -> política que impide completar acción\n  - \"loop_o_confusion\" -> bucle o confusión en la conversación\n  - \"cliente_no_responde\" -> el cliente no responde o cierra\n  - \"otro\"\n  - null si resolution_ok=true\nSi resolution_ok=true => no_resolution_reason=null y resolution_status NO debe ser \"fallido\".\n\n5) Extracción de entidades (solo si aparecen explícitas)\n- pedido_accion (texto recomendado):\n  - \"create\" | \"track\" | \"modify\" | \"cancel\" | null\n- pedido_codigo: string|null (código/ID explícito)\n- pedido_plataforma (texto recomendado):\n  - \"masdelivery\" | \"pedidosya\" | \"web\" | \"whatsapp\" | \"desconocido\"\n- pedido_tipo_entrega: \"delivery\" | \"retiro\" | null (solo si lo dicen)\n- pedido_estado: texto recomendado:\n  - \"recibido\" | \"en_preparacion\" | \"listo\" | \"en_viaje\" | \"entregado\" | \"cancelado\" | \"desconocido\"\n  Reglas:\n  - Solo usar un estado como verdad si aparece explícito con certeza en el chat (por usuario/humano o por resultado explícito).\n  - Si el AI lo afirma sin fuente: pedido_estado=\"desconocido\" y afirmacion_estado_sin_fuente=true.\n- pedido_fecha: \"YYYY-MM-DD\"|null (si se menciona con certeza)\n- pedido_hora: \"HH:MM\"|\"HH:MM:SS\"|null (si se menciona con certeza)\n- cliente_nombre: string|null (si lo aporta explícitamente)\n- sucursal_detectada: string|null (si se menciona explícitamente)\n\n6) Calidad del flujo\n- confirmacion_explicita:\n  true si existe confirmación explícita de cualquiera de las partes sobre un dato/acción (p.ej. “confirmo”, “ok”, “sí” ante una propuesta concreta).\n- repreguntas_count:\n  cuántas veces la IA pide un dato ya entregado por el humano (código, nombre, plataforma, etc.)\n- claridad_siguiente_paso: 0|1|2\n  - 2: siguiente paso concreto y accionable\n  - 1: hay siguiente paso pero incompleto/ambiguo\n  - 0: no hay\n- friccion_score: 0..5 (enteros)\n  Suma sugerida (cap a 5):\n  +2 queja/enojo (“mal”, “tardan”, insultos)\n  +1 si la IA comete error evidente (fecha/hora/política)\n  +1 confusión (“no entiendo”, “cómo”, “qué hago”)\n  +1 repetición del mismo pedido sin avance\n  +1 conversación larga sin progreso\n- consistencia_sucursal:\n  true si no hay contradicción en sucursal; false si cambia; null si no se menciona.\n\n7) Sentimiento (texto libre con catálogo recomendado)\nsentiment_inicio y sentiment_final (texto recomendado):\n- \"positivo\" | \"neutral\" | \"negativo\" | \"mixto\" | \"desconocido\"\n\n8) Escalación\n- escalado: true si se indica explícitamente que un humano continuará (“te escribe alguien”, “paso a un compañero”, etc.)\n- escalacion_tipo (texto recomendado): \n  \"politica\" | \"incertidumbre\" | \"error_tecnico\" | \"queja\" | \"peticion_cliente\" | \"loop_conversacional\" | \"otro\" | null\n- escalacion_turno: integer|null (turno donde ocurre primera mención de escalación)\n- handoff_quality: 0|1|2|null\n  - 2: resumen + datos clave + siguiente paso claro\n  - 1: parcial\n  - 0: sin contexto\nRegla:\n- Si escalado=false => escalacion_tipo=null, escalacion_turno=null, handoff_quality=null.\n\n9) Veracidad / errores\n- error_detectado: true SOLO si hay evidencia clara de error/bucle/contradicción.\n- error_tipo (texto recomendado):\n  \"invento_info\" | \"estado_inventado\" | \"eta_inventado\" | \"politica_mal_aplicada\" | \"contradiccion\" | \"loop\" | \"otro\" | null\n\n10) Riesgo / mejoras (texto libre)\n- riesgo_negocio: \"low\" | \"med\" | \"high\" (recomendado)\n- improvement_tag: string|null (texto libre; usa tags consistentes, p.ej. \"kb\", \"flujo_preguntas\", \"handoff_humano\", etc.)\n\n11) Evidencia\n- evidence_message_ids:\n  lista de 2 a 6 ids que sustenten intent, resolución, escalación o error. Si no hay ids, [].\nRegla:\n- Si resolution_ok=true o escalado=true o error_detectado=true => evidence_message_ids NO debe ser [].\n- evidence_snippet:\n  1-2 líneas <= 250 caracteres con extracto mínimo (sin inventar).\n- datos_faltantes:\n  arreglo de strings con campos relevantes que quedaron null/[] por falta de evidencia.\n\n12) entidades_json (jsonb)\nEstructura mínima:\n{\n  \"extracted\": { ... },\n  \"confidence\": { \"campo\": 0.0-1.0, ... },\n  \"notes\": [ ... ]\n}\n\nSALIDA (FORMATO ESTRICTO)\nResponde EXCLUSIVAMENTE con UN ÚNICO JSON válido, sin markdown, sin comentarios, sin texto adicional.\nLas claves deben coincidir EXACTAMENTE con las columnas de osaki_analytics.auditoria_conversacion_delivery:\n\n```json\n{\n  \"conversation_id\": \"string\",\n  \"channel\": \"string\",\n  \"agent\": \"string\",\n  \"brand\": \"string|null\",\n  \"sucursal_detectada\": \"string|null\",\n\n  \"first_user_ts\": \"timestamp|null\",  // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"last_user_ts\": \"timestamp|null\",   // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"duration_sec\": \"number|null\", // número entero >=0\n\n  \"session_count\": 1, // número de sesiones detectadas\n  \"session_rule\": \"gap_human_gt_30m\", \n  \"max_gap_minutes\": \"number|null\", // número entero >=0\n\n  \"msg_count_total\": 0, // número de mensajes en total\n  \"msg_count_ai\": 0, // número de mensajes del AI\n  \"msg_count_human\": 0, // número de mensajes del humano\n  \"turn_count\": 0,  // min(msg_count_human, msg_count_ai)\n\n  \"intent_principal\": \"crear_pedido|rastrear_pedido|modificar_pedido|cancelar_pedido|consultar_menu|consultar_promociones|consultar_horarios|consultar_ubicacion|reservacion_mesa|seguimiento_pedido|notificacion_pedido|otro\",  //  ENUM ¿Cuál es el objetivo dominante del humano?\n  \"intents_secundarios\": [],  // arreglo de strings (sin duplicar intent_principal). Si no hay, []\n\n  \"resolution_status\": \"exitoso|parcial|fallido|derivado_humano|abandonado|otro\", // estado de resolución del intent principal\n  \"resolution_ok\": \"true|false\", // boolean, si el intento principal se logró\n  \"no_resolution_reason\": \"faltan_datos_cliente|faltan_datos_negocio|error_herramienta|politica_negocio|loop_o_confusion|cliente_no_responde|otro|null\", // null si resolution_ok es true\n\n  \"pedido_accion\": \"create|track|modify|cancel|null\", // Si hay un pedido explícito\n  \"pedido_codigo\": \"string|null\",\n  \"pedido_plataforma\": \"masdelivery|pedidosya|web|whatsapp|desconocido\",\n  \"pedido_tipo_entrega\": \"delivery|retiro|null\",\n  \"pedido_estado\": \"string\",\n  \"pedido_fecha\": \"YYYY-MM-DD|null\",\n  \"pedido_hora\": \"HH:MM|HH:MM:SS|null\",\n\n  \"cliente_nombre\": \"string|null\",\n\n  \"confirmacion_explicita\": \"true|false\", // boolean si la IA pide confirmación explícita\n  \"repreguntas_count\": 0, // número de repreguntas sobre datos ya dados\n  \"claridad_siguiente_paso\": \"0|1|2\",  // 0: no hay; 1: ambiguo/incompleto; 2: claro\n  \"consistencia_sucursal\": \"true|false|null\", // null si no se menciona\n  \"friccion_score\": \"0|1|2|3|4|5|6\", // 0 (sin fricción) a 6 (mucha fricción)\n\n  \"sentiment_inicio\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al inicio de la conversación\n  \"sentiment_final\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al final de la conversación\n  \"tono_ai\": \"cordial|profesional|efusivo|otro\", // etiqueta breve según estilo del bot\n\n  \"escalado\": \"true|false\", // boolean si hubo escalación a humano\n  \"escalacion_tipo\": \"politica|incertidumbre|error_tecnico|queja|peticion_cliente|loop_conversacional|otro|null\", // null si escalado es false\n  \"escalacion_turno\": \"number|null\", //  null si escalado es false\n  \"handoff_quality\": \"number|null\",\n\n  \"afirmacion_estado_sin_fuente\": \"true|false\", // boolean si el bot afirma estado sin evidencia de consulta a herramienta\n  \"afirmacion_eta_sin_fuente\": \"true|false\", // boolean si el bot afirma ETA sin evidencia de consulta a herramienta\n\n  \"error_detectado\": \"true|false\", // boolean si hay evidencia interna de error/contradicción por parte de la IA\n  \"error_tipo\": \"invento_info|estado_inventado|eta_inventado|politica_mal_aplicada|contradiccion|loop|otro|null\", // null si error_detectado es false\n\n  \"riesgo_negocio\": \"high|med|low\", // nivel de riesgo detectado\n  \"improvement_tag\": \"prompt|kb|flujo_preguntas|validaciones_fecha_hora|integracion_calendario|multi_sucursal|tono|seguridad_privacidad|handoff_humano|otro|null\", // null si no aplica\n\n  \"evidence_message_ids\": [],\n  \"evidence_snippet\": \"string|null\",\n  \"datos_faltantes\": [],\n\n  \"entidades_json\": { \"extracted\": {}, \"confidence\": {}, \"notes\": [] },\n  \"messages_json\": null,\n\n  \"analyzed_by\": \"audit-llm-delivery-v1\"\n}\n```\n\nVALIDACIONES FINALES (OBLIGATORIAS)\n- No “rellenes” con suposiciones: si falta evidencia => null/[] + datos_faltantes.\n- Si resolution_ok=true => resolution_status != \"fallido\" y no_resolution_reason=null.\n- Si escalado=false => escalacion_* = null y handoff_quality=null.\n- Si (resolution_ok=true) OR (escalado=true) OR (error_detectado=true) => evidence_message_ids no puede ser [].\n- Usa español.\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3,
        "position": [
          -144,
          1056
        ],
        "id": "10780cdb-6ac0-4297-90bb-52c85746f86c",
        "name": "AI Agent_Delivery_9"
      },
      {
        "parameters": {
          "jsCode": "// Iteramos sobre todos los items\nreturn items.map(item => {\n  try {\n    // 1. Obtenemos el string\n    let rawContent = item.json.output || \"\";\n\n    // 2. Limpieza de Markdown (Como antes)\n    let cleanContent = rawContent\n      .replace(/^```json\\s*/i, '')\n      .replace(/^```\\s*/i, '')\n      .replace(/\\s*```$/, '')\n      .trim();\n\n    // -----------------------------------------------------------\n    // 3. REPARACIÓN DE JSON ROTO (El Parche)\n    // -----------------------------------------------------------\n    // El error es: cierra una propiedad con \", en lugar de },\n    // Buscamos: Salto de linea (\\n) -> Espacios (\\s*) -> Comilla (\") -> Coma (,)\n    // Y lo reemplazamos por: },\n    // Nota: Usamos una Regex específica para no romper otros textos.\n    \n    cleanContent = cleanContent.replace(/(\\n\\s*)\"\\s*,/g, '$1},');\n\n    // -----------------------------------------------------------\n\n    // 4. Parseo\n    const parsedData = JSON.parse(cleanContent);\n\n    // 5. Retorno Exitoso\n    return {\n      json: parsedData\n    };\n\n  } catch (error) {\n    // Si falla de nuevo, te dará detalles más precisos\n    return {\n      json: {\n        error: true,\n        message: \"Aún fallando el parseo. Revisa 'cleaned_string' para ver el error.\",\n        original_error: error.message,\n        // Devolvemos el string limpio para que veas si el parche funcionó visualmente\n        cleaned_string: error.input_string_debug \n      }\n    };\n  }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          176,
          1056
        ],
        "id": "0b70fa27-46b6-4e21-ae38-6c5ef5cc4b13",
        "name": "Normaliza Salida_Delivery_9"
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "value": "osaki_analytics",
            "mode": "list",
            "cachedResultName": "osaki_analytics"
          },
          "table": {
            "__rl": true,
            "value": "auditoria_conversacion_delivery",
            "mode": "list",
            "cachedResultName": "auditoria_conversacion_delivery"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "resolution_ok": "={{ $json.resolution_ok }}",
              "confirmacion_explicita": "={{ $json.confirmacion_explicita }}",
              "consistencia_sucursal": "={{ $json.consistencia_sucursal }}",
              "escalado": "={{ $json.escalado }}",
              "afirmacion_estado_sin_fuente": "={{ $json.afirmacion_estado_sin_fuente }}",
              "afirmacion_eta_sin_fuente": "={{ $json.afirmacion_eta_sin_fuente }}",
              "error_detectado": "={{ $json.error_detectado }}",
              "channel": "WhatsApp",
              "agent": "Delivery",
              "brand": "Osaki",
              "sucursal_detectada": "Calle 9",
              "first_user_ts": "={{ $json.first_user_ts }}",
              "last_user_ts": "={{ $json.last_user_ts }}",
              "duration_sec": "={{ $json.duration_sec }}",
              "session_count": "={{ $json.session_count }}",
              "session_rule": "={{ $json.session_rule }}",
              "max_gap_minutes": "={{ $json.max_gap_minutes }}",
              "msg_count_total": "={{ $json.msg_count_total }}",
              "msg_count_ai": "={{ $json.msg_count_ai }}",
              "msg_count_human": "={{ $json.msg_count_human }}",
              "turn_count": "={{ $json.turn_count }}",
              "intent_principal": "={{ $json.intent_principal }}",
              "intents_secundarios": "={{ $json.intents_secundarios }}",
              "resolution_status": "={{ $json.resolution_status }}",
              "no_resolution_reason": "={{ $json.no_resolution_reason }}",
              "pedido_accion": "={{ $json.pedido_accion }}",
              "pedido_codigo": "={{ $json.pedido_codigo }}",
              "pedido_plataforma": "={{ $json.pedido_plataforma }}",
              "pedido_tipo_entrega": "={{ $json.pedido_tipo_entrega }}",
              "pedido_estado": "={{ $json.pedido_estado }}",
              "pedido_fecha": "={{ $json.pedido_fecha }}",
              "pedido_hora": "={{ $json.pedido_hora }}",
              "cliente_nombre": "={{ $json.cliente_nombre }}",
              "repreguntas_count": "={{ $json.repreguntas_count }}",
              "claridad_siguiente_paso": "={{ $json.claridad_siguiente_paso }}",
              "friccion_score": "={{ $json.friccion_score }}",
              "sentiment_inicio": "={{ $json.sentiment_inicio }}",
              "sentiment_final": "={{ $json.sentiment_final }}",
              "tono_ai": "={{ $json.tono_ai }}",
              "escalacion_tipo": "={{ $json.escalacion_tipo }}",
              "escalacion_turno": "={{ $json.escalacion_turno }}",
              "handoff_quality": "={{ $json.handoff_quality }}",
              "error_tipo": "={{ $json.error_tipo }}",
              "riesgo_negocio": "={{ $json.riesgo_negocio }}",
              "improvement_tag": "={{ $json.improvement_tag }}",
              "evidence_message_ids": "={{ $json.evidence_message_ids }}",
              "evidence_snippet": "={{ $json.evidence_snippet }}",
              "datos_faltantes": "={{ $json.datos_faltantes }}",
              "entidades_json": "={{ $json.entidades_json }}",
              "analyzed_by": "={{ $json.analyzed_by }}",
              "messages_json": "={{ { \"conversacion\": $('Aggregate_Delivery_9').item.json.data } }}",
              "analyzed_at": "={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat(\"yyyy-MM-dd'T'HH:mm:ss.000'Z'\") }}",
              "session_id": "={{ $('Loop Over Items_Delivery_9').item.json.session_id }}",
              "mes_analisis": "={{ $('Initial Data').item.json.mes_anterior }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "audit_id",
                "displayName": "audit_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "session_id",
                "displayName": "session_id",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "channel",
                "displayName": "channel",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "agent",
                "displayName": "agent",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "brand",
                "displayName": "brand",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "sucursal_detectada",
                "displayName": "sucursal_detectada",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "first_user_ts",
                "displayName": "first_user_ts",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "last_user_ts",
                "displayName": "last_user_ts",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "duration_sec",
                "displayName": "duration_sec",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "session_count",
                "displayName": "session_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "session_rule",
                "displayName": "session_rule",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "max_gap_minutes",
                "displayName": "max_gap_minutes",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_total",
                "displayName": "msg_count_total",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_ai",
                "displayName": "msg_count_ai",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "msg_count_human",
                "displayName": "msg_count_human",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "turn_count",
                "displayName": "turn_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "intent_principal",
                "displayName": "intent_principal",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "intents_secundarios",
                "displayName": "intents_secundarios",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "resolution_status",
                "displayName": "resolution_status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "resolution_ok",
                "displayName": "resolution_ok",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "no_resolution_reason",
                "displayName": "no_resolution_reason",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_accion",
                "displayName": "pedido_accion",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_codigo",
                "displayName": "pedido_codigo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_plataforma",
                "displayName": "pedido_plataforma",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_tipo_entrega",
                "displayName": "pedido_tipo_entrega",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_estado",
                "displayName": "pedido_estado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_fecha",
                "displayName": "pedido_fecha",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "pedido_hora",
                "displayName": "pedido_hora",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "time",
                "canBeUsedToMatch": true
              },
              {
                "id": "cliente_nombre",
                "displayName": "cliente_nombre",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "confirmacion_explicita",
                "displayName": "confirmacion_explicita",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "repreguntas_count",
                "displayName": "repreguntas_count",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "claridad_siguiente_paso",
                "displayName": "claridad_siguiente_paso",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "consistencia_sucursal",
                "displayName": "consistencia_sucursal",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "friccion_score",
                "displayName": "friccion_score",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "sentiment_inicio",
                "displayName": "sentiment_inicio",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "sentiment_final",
                "displayName": "sentiment_final",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "tono_ai",
                "displayName": "tono_ai",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalado",
                "displayName": "escalado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalacion_tipo",
                "displayName": "escalacion_tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "escalacion_turno",
                "displayName": "escalacion_turno",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "handoff_quality",
                "displayName": "handoff_quality",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "afirmacion_estado_sin_fuente",
                "displayName": "afirmacion_estado_sin_fuente",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "afirmacion_eta_sin_fuente",
                "displayName": "afirmacion_eta_sin_fuente",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "error_detectado",
                "displayName": "error_detectado",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "boolean",
                "canBeUsedToMatch": true
              },
              {
                "id": "error_tipo",
                "displayName": "error_tipo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "riesgo_negocio",
                "displayName": "riesgo_negocio",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "improvement_tag",
                "displayName": "improvement_tag",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "evidence_message_ids",
                "displayName": "evidence_message_ids",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "evidence_snippet",
                "displayName": "evidence_snippet",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "datos_faltantes",
                "displayName": "datos_faltantes",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": true
              },
              {
                "id": "entidades_json",
                "displayName": "entidades_json",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              },
              {
                "id": "messages_json",
                "displayName": "messages_json",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "object",
                "canBeUsedToMatch": true
              },
              {
                "id": "analyzed_by",
                "displayName": "analyzed_by",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "analyzed_at",
                "displayName": "analyzed_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              },
              {
                "id": "mes_analisis",
                "displayName": "mes_analisis",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          400,
          1056
        ],
        "id": "a665c01c-a7d1-460c-a326-d421e1296c47",
        "name": "Registra Analisis_Delivery_9",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "faf12f8f-17b5-473d-8de0-2a2fc8038ca4",
                "leftValue": "={{ $json.success }}",
                "rightValue": false,
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -768,
          1120
        ],
        "id": "fd76e91b-f9cd-446a-95f7-8d7b9292d50c",
        "name": "If"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "faf12f8f-17b5-473d-8de0-2a2fc8038ca4",
                "leftValue": "={{ $json.success }}",
                "rightValue": false,
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -800,
          672
        ],
        "id": "20635720-956a-4f49-a930-ca8158ef942b",
        "name": "If1"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "faf12f8f-17b5-473d-8de0-2a2fc8038ca4",
                "leftValue": "={{ $json.success }}",
                "rightValue": false,
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -800,
          272
        ],
        "id": "2b3c5dd5-663b-42a7-a263-d85b58953e13",
        "name": "If2"
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "cronExpression",
                "expression": "0 0 3 1 * * "
              }
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.3,
        "position": [
          -1968,
          656
        ],
        "id": "39259780-4913-4d9c-bb9d-2ccde405254c",
        "name": "Schedule Trigger"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "\nSELECT DISTINCT ch.session_id\n       --ch.ultimos_10_numeros\nFROM (\n    SELECT session_id,\n           RIGHT(SPLIT_PART(session_id, '@', 1), 10) as ultimos_10_numeros\n    FROM (\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n        UNION\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_bkup\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n    ) t\n) ch\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM osaki_analytics.auditoria_conversacion_reservas a\n    WHERE a.session_id = ch.session_id\n    AND a.mes_analisis = '{{ $json.mes_anterior }}'\n)\nAND NOT EXISTS (\n    SELECT 1\n    FROM osaki_main.blacklist_phones_calle_47 b\n    WHERE b.phone = ch.ultimos_10_numeros::bigint\n)\nORDER BY ch.session_id ASC;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -1264,
          256
        ],
        "id": "58eb16af-8c11-45c6-ad83-9c519c86dc71",
        "name": "Get Session Id",
        "credentials": {
          "postgres": {
            "id": "sk75eTZ4yDkbl8mt",
            "name": "Postgres Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "8d3fec7f-2a0c-4baf-87cf-8270fd3993a2",
                "name": "schema_analytics",
                "value": "osaki_analytics",
                "type": "string"
              },
              {
                "id": "39321030-5d85-4f15-a9f3-e9f63fd58c1f",
                "name": "schema_data",
                "value": "osaki_main",
                "type": "string"
              },
              {
                "id": "cc789ac2-2002-4da4-97f9-607b7fc9b10a",
                "name": "fec_initial",
                "value": "={{ $now.setZone('America/Argentina/Buenos_Aires').minus({ months: 1 }).startOf('month').toFormat('yyyy-MM-dd') }}",
                "type": "string"
              },
              {
                "id": "a7b2348e-ee7b-4315-ac82-94588a9c2a3c",
                "name": "fec_final",
                "value": "={{ $now.setZone('America/Argentina/Buenos_Aires').startOf('month').toFormat('yyyy-MM-dd') }}",
                "type": "string"
              },
              {
                "id": "40fd67c4-188b-49f7-b8a6-6a2b732dd727",
                "name": "mes_anterior",
                "value": "={{ $now.setZone('America/Argentina/Buenos_Aires').minus({ months: 1 }).setLocale('es').toFormat('MMMM').replace(/^\\w/, (c) => c.toUpperCase()) }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1696,
          656
        ],
        "id": "0b39ba64-b501-4619-b68b-2278e25e6356",
        "name": "Initial Data"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4.1-mini"
          },
          "builtInTools": {},
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.3,
        "position": [
          -80,
          720
        ],
        "id": "2d919cfb-659a-4c26-8764-4b0fb80adb3a",
        "name": "OpenAI",
        "credentials": {
          "openAiApi": {
            "id": "fATP1TjAWkMAqBDc",
            "name": "OpenAi Osaki-TemikiaProd01"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          -176,
          720
        ],
        "id": "6bf3d67b-0fcb-45e8-aec8-ab2dd80043a6",
        "name": "Gemini",
        "credentials": {
          "googlePalmApi": {
            "id": "OAlDnAQJQHCtNBVS",
            "name": "Google Gemini(PaLM) Osaki-TemikiaProd01"
          }
        }
      }
    ],
    "connections": {
      "Get Conversation": {
        "main": [
          [
            {
              "node": "Aggregate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate": {
        "main": [
          [
            {
              "node": "AI Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent": {
        "main": [
          [
            {
              "node": "Normaliza Salida",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Normaliza Salida": {
        "main": [
          [
            {
              "node": "Registra Analisis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [],
          [
            {
              "node": "If2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Registra Analisis": {
        "main": [
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "AI Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait1": {
        "main": [
          [
            {
              "node": "Loop Over Items_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Chat Model2": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent_Delivery_9",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Wait2": {
        "main": [
          [
            {
              "node": "Loop Over Items_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Session_Ids_Delivery_47": {
        "main": [
          [
            {
              "node": "Loop Over Items_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items_Delivery_47": {
        "main": [
          [],
          [
            {
              "node": "If1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Conversation_Delivery_47": {
        "main": [
          [
            {
              "node": "Aggregate_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate_Delivery_47": {
        "main": [
          [
            {
              "node": "AI Agent_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent_Delivery_47": {
        "main": [
          [
            {
              "node": "Normaliza Salida_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Normaliza Salida_Delivery_47": {
        "main": [
          [
            {
              "node": "Registra Analisis_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Registra Analisis_Delivery_47": {
        "main": [
          [
            {
              "node": "Wait1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "AI Agent_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Session_Ids_Delivery_9": {
        "main": [
          [
            {
              "node": "Loop Over Items_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items_Delivery_9": {
        "main": [
          [],
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Conversation_Delivery_9": {
        "main": [
          [
            {
              "node": "Aggregate_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate_Delivery_9": {
        "main": [
          [
            {
              "node": "AI Agent_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent_Delivery_9": {
        "main": [
          [
            {
              "node": "Normaliza Salida_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Normaliza Salida_Delivery_9": {
        "main": [
          [
            {
              "node": "Registra Analisis_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Registra Analisis_Delivery_9": {
        "main": [
          [
            {
              "node": "Wait2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "AI Agent_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "Get Conversation_Delivery_9",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Loop Over Items_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If1": {
        "main": [
          [
            {
              "node": "Get Conversation_Delivery_47",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Loop Over Items_Delivery_47",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If2": {
        "main": [
          [
            {
              "node": "Get Conversation",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Schedule Trigger": {
        "main": [
          [
            {
              "node": "Initial Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Session Id": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Initial Data": {
        "main": [
          [
            {
              "node": "Get Session Id",
              "type": "main",
              "index": 0
            },
            {
              "node": "Get Session_Ids_Delivery_47",
              "type": "main",
              "index": 0
            },
            {
              "node": "Get Session_Ids_Delivery_9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent_Delivery_47",
              "type": "ai_languageModel",
              "index": 1
            }
          ]
        ]
      },
      "Gemini": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent_Delivery_47",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Temikia Agency",
    "name": "Version fcb8c632",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "fcb8c632-a0be-4420-8074-a1f3a280b1e3",
  "connections": {
    "Get Conversation": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Normaliza Salida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normaliza Salida": {
      "main": [
        [
          {
            "node": "Registra Analisis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registra Analisis": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Loop Over Items_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent_Delivery_9",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Loop Over Items_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Session_Ids_Delivery_47": {
      "main": [
        [
          {
            "node": "Loop Over Items_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items_Delivery_47": {
      "main": [
        [],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Conversation_Delivery_47": {
      "main": [
        [
          {
            "node": "Aggregate_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate_Delivery_47": {
      "main": [
        [
          {
            "node": "AI Agent_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent_Delivery_47": {
      "main": [
        [
          {
            "node": "Normaliza Salida_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normaliza Salida_Delivery_47": {
      "main": [
        [
          {
            "node": "Registra Analisis_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registra Analisis_Delivery_47": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Session_Ids_Delivery_9": {
      "main": [
        [
          {
            "node": "Loop Over Items_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items_Delivery_9": {
      "main": [
        [],
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Conversation_Delivery_9": {
      "main": [
        [
          {
            "node": "Aggregate_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate_Delivery_9": {
      "main": [
        [
          {
            "node": "AI Agent_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent_Delivery_9": {
      "main": [
        [
          {
            "node": "Normaliza Salida_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normaliza Salida_Delivery_9": {
      "main": [
        [
          {
            "node": "Registra Analisis_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registra Analisis_Delivery_9": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Get Conversation_Delivery_9",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Get Conversation_Delivery_47",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items_Delivery_47",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Get Conversation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Initial Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Session Id": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initial Data": {
      "main": [
        [
          {
            "node": "Get Session Id",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Session_Ids_Delivery_47",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Session_Ids_Delivery_9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent_Delivery_47",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Gemini": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent_Delivery_47",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-25T18:52:42.677Z",
  "id": "kKkB2zB1kibZ3wus",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Llena Tabla Auditoría",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH raw_messages AS (\n    -- Paso 1: Obtenemos los últimos 10 registros de la tabla principal\n    SELECT \n        id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'main' as source\n    FROM osaki_main.n8n_chat_histories\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n\n    UNION \n    -- Paso 2: Obtenemos los últimos 10 registros del backup\n    SELECT \n        old_id as id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'backup' as source\n    FROM osaki_main.n8n_chat_histories_bkup\n    WHERE session_id = $1\n      AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n  ),\ncleaned_content AS (\n    -- Paso 3: Limpiamos el ruido inicial (ej: [Used tools...]) una sola vez\n    SELECT \n        id,\n        type,\n        regexp_replace(raw_content, '^\\[Used tools:.*\\]\\]\\s*', '') AS content\n    FROM raw_messages\n)\n-- Paso 4: Aplicamos la lógica de extracción de fecha y texto final\nSELECT\n    CASE \n        WHEN type = 'human' THEN \n            to_char(\n                to_timestamp(\n                    -- Extraemos la fecha y normalizamos guiones a barras\n                    replace(\n                        substring(content FROM '(?i)fecha\\s*y\\s*hora:\\s*([0-9]{4}[/-][0-9]{2}[/-][0-9]{2}\\s*[0-9]{2}:[0-9]{2}:[0-9]{2})'),\n                        '-', '/'\n                    ), \n                    'YYYY/MM/DD HH24:MI:SS'\n                ), \n                'YYYY/MM/DD HH24:MI:SS'\n            )\n        ELSE NULL \n    END AS fecha_hora,\n    \n    id,\n    type,\n    \n    CASE \n        WHEN type = 'human' THEN \n            trim(\n                regexp_replace(\n                    split_part(content, 'Mensaje de Texto o Descripción:', 2),\n                    '\\s+', ' ', 'g'\n                )\n            )\n        ELSE content \n    END AS content\nFROM cleaned_content\nORDER BY id asc;\n",
        "options": {
          "queryReplacement": "={{ $json.session_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -560,
        208
      ],
      "id": "d8227be3-4d73-4470-bec7-d1414cfb11fa",
      "name": "Get Conversation",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify({\n  conversation_id: $('Loop Over Items').item.json.session_id ,\n  messages: $input.all().map(i => i.json)\n}) }}\n",
        "options": {
          "systemMessage": "=ROL\nEres un auditor automático de conversaciones de WhatsApp para un agente de RESERVAS de restaurante. (Humano = cliente, AI = bot del negocio).\nTu tarea es analizar una conversación (lista de mensajes) y producir UN ÚNICO JSON con las columnas de la tabla\nauditoria_conversacion_reservas.\n\nREGLA CRÍTICA ANTI-ALUCINACIÓN (OBLIGATORIA)\n- Solo puedes afirmar datos explícitos en los mensajes de entrada.\n- Si un dato no aparece o no puede inferirse de forma determinística, usa null (o [] para arreglos) y agrega el campo a datos_faltantes.\n- No inventes disponibilidad, consultas a calendario, políticas, identidades, ni acciones de herramientas.\n- Si el bot afirma “tenemos disponibilidad” o similar, y NO existe evidencia en el input de que consultó una herramienta/calendario/DB,\n  entonces afirmacion_disponibilidad_sin_fuente = true.\n\nINPUT (FORMATO)\nRecibirás un único JSON con:\n- conversation_id: string\n- messages: array de objetos { fecha_hora, id, type ('human'|'ai'), content }\n\nREGLAS DE CÁLCULO\n\n1) Normalización de timestamps\n- fecha_hora viene como string tipo \"YYYY/MM/DD HH:MM:SS\" o null.\n- Parsear solo timestamps no nulos.\n- first_user_ts = primer timestamp no nulo con type='human'\n- last_user_ts  = último timestamp no nulo con type='human'\n- duration_sec = (last_user_ts - first_user_ts) en segundos si ambos existen; si no, null.\n\n2) Sessionization\n- Nueva sesión si el gap entre MENSAJES HUMANOS consecutivos > 30 minutos.\n- session_rule = \"gap_human_gt_30m\"\n- session_count = cantidad de sesiones detectadas\n- max_gap_minutes = máximo gap (minutos) detectado entre mensajes humanos consecutivos (si hay al menos 2 timestamps humanos); si no, null.\n\n3) Conteos\n- msg_count_total = total mensajes\n- msg_count_ai = count(type='ai')\n- msg_count_human = count(type='human')\n- turn_count = min(msg_count_human, msg_count_ai) (aprox)\n\n4) Detección de intención (intent_principal) según el objetivo dominante del humano:\n- reservar -> quiere crear reserva\n- modificar_reserva -> quiere cambiar hora/fecha/zona/personas de reserva existente\n- cancelar_reserva -> quiere cancelar\n- consultar_disponibilidad -> pregunta si hay lugar\n- consultar_horarios -> horarios de atención\n- consultar_ubicacion -> dirección, mapa, sucursal\n- consultar_menu -> menú, carta\n- consultar_promociones -> promos, descuentos\n- pedido -> pedidos, delivery, take away\n- otro -> no encaja\n\nintents_secundarios: lista (sin duplicados) si detectas más de un objetivo claro.\n\n5) Resolución\n- resolution_ok = true si intent_principal fue exitoso (reserva creada/modificada/cancelada o info entregada y humano cierra conforme);\n  false si no se logró o quedó inconcluso.\n  \n- resolution_status:\n  - reservado | modificado | cancelado -> si se logró la acción principal\n  - informacion_entregada -> si se respondió consulta y humano cierra conforme\n  - derivado_humano -> si escaló a humano antes de resolución\n  - abandonado -> si humano deja de responder antes de resolución\n  - fallido -> si no se logró (ej: no hay disponibilidad, error, confusión)\n\n- no_resolution_reason SOLO si resolution_ok = false (si no aplica, null).\n  - faltan_datos_cliente -> humano no da datos necesarios (fecha, hora, pax, etc.)\n  - faltan_datos_negocio -> bot no tiene info necesaria (política, disponibilidad, etc.)\n  - error_herramienta -> falla técnica o error en consulta a herramienta\n  - politica_negocio -> política impide completar (no reservas, no cambios, etc.)\n  - loop_o_confusion -> confusión o loop sin avance claro\n  - cliente_no_responde -> humano deja de responder\n  - otro -> no encaja\n  - null -> si resolution_ok = true\n\n6) Extracción de entidades (solo si aparecen explícitas)\n- reserva_accion: \"create\" | \"modify\" | \"cancel\" (si no se identifica, null)\n- reserva_codigo: código tipo \"OSK-...\" (si aparece)\n- reserva_fecha: DATE (YYYY-MM-DD) si se puede extraer con certeza\n- reserva_hora: TIME (HH:MM:SS o HH:MM) si se puede extraer con certeza\n- reserva_pax: número de personas (>=1) si aparece\n- reserva_zona: \"Salón\", \"Barra\", etc. si aparece\n- cliente_nombre: nombre si el humano lo proporciona\n\n7) Calidad del flujo\n- confirmacion_explicita = true si la IA resume datos y pide confirmación (Sí/No o equivalente)\n- repreguntas_count: número de veces que la IA pide el mismo dato ya entregado por el humano\n- claridad_siguiente_paso:\n  - 2 si la IA deja un siguiente paso concreto y accionable (confirmar, enviar datos, presentarse a hora X, etc.)\n  - 1 si hay siguiente paso pero ambiguo\n  - 0 si no hay\n- friccion_score (0-6):\n  +2 si hay queja/enojo por parte del humano\n  +1 si la IA comete error evidente (fecha/hora/política)\n  +1 si hay confusión (“no entiendo”, “no me funciona”, “¿cómo?”)\n  +1 si hay repetición del mismo pedido por parte del humano\n  +1 si se extiende sin avance claro (o muchas vueltas)\n- consistencia_sucursal:\n  true si cuando se menciona sucursal/dirección no hay contradicción; false si cambia; null si nunca menciona.\n\n8) Escalación\n- escalado=true si la IA indica explícitamente que un humano continuará / derivación / “te contacta alguien”\n- escalacion_tipo: politica | incertidumbre | error_tecnico | queja | peticion_cliente | loop_conversacional | otro\n- escalacion_turno: turno (1..N) aproximado donde ocurrió (primer mensaje de escalación)\n- handoff_quality:\n  - 2 si deja resumen completo (problema + datos + próximo paso)\n  - 1 si deja parcial\n  - 0 si no deja contexto\n  - null si no hay escalación\n\n9) Sentimiento y tono\n- sentiment_inicio y sentiment_final: positivo | neutral | negativo | mixto | desconocido según señales textuales del HUMANO.\n- tono_ai: etiqueta breve (cordial/profesional/efusivo) según estilo del bot.\n\n10) Veracidad / riesgo\n- error_detectado = true SOLO si el chat contiene evidencia interna de error/contradicción clara por parte de la IA.\n- error_tipo: invento_info | sucursal_incorrecta | fecha_hora_incorrecta | politica_mal_aplicada | contradiccion | otro (si error_detectado=true; si no, null)\n- riesgo_negocio:\n  - high si dirección/fecha/hora/código se contradicen o confirman algo errado\n  - med si hay confusión relevante o afirmaciones sensibles sin sustento\n  - low si consistente\n- afirmacion_disponibilidad_sin_fuente = true si el bot afirma disponibilidad sin evidencia de consulta a herramienta en el input.\n\n11) Evidencia y mejoras\n- evidence_message_ids: ids numéricos de 2 a 6 mensajes clave que sustenten tus decisiones (intent, cierre, escalación, error).\n- evidence_snippet: 1-2 líneas (<= 250 caracteres) citando el contenido esencial (parafraseado o extracto corto).\n- improvement_tag: prompt | kb | flujo_preguntas | validaciones_fecha_hora | integracion_calendario | multi_sucursal | tono | seguridad_privacidad | handoff_humano | otro\n  Debe ser null si no hay mejora clara.\n- datos_faltantes: arreglo de strings con campos importantes faltantes (ej: \"reserva_fecha\", \"reserva_hora\", \"reserva_pax\") si afectó la resolución.\n\n12) entidades_json\nGenera un JSONB con:\n{\n  \"extracted\": { ...campos... },\n  \"confidence\": { \"campo\": 0.0-1.0, ... },\n  \"notes\": [ \"reglas aplicadas\", \"decisiones relevantes\" ]\n}\n\nSALIDA (FORMATO ESTRICTO)\nResponde EXCLUSIVAMENTE con UN ÚNICO JSON válido, sin markdown, sin comentarios, sin texto adicional.\nLas claves deben coincidir EXACTAMENTE con las columnas de auditoria_conversacion_reservas:\n\n```json\n{\n  \"conversation_id\": \"string\",\n  \"channel\": \"whatsapp\",\n  \"agent\": \"reservas\",\n  \"brand\": \"Osaki\",\n  \"sucursal_detectada\": \"Calle 47 - Restó\",\n  \"first_user_ts\": null, // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"last_user_ts\": null, // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"duration_sec\": null, // número o null\n  \"session_count\": 1, // número de sesiones detectadas\n  \"session_rule\": \"gap_human_gt_30m\",\n  \"max_gap_minutes\": null, // número o null\n  \"msg_count_total\": 0,  // total mensajes\n  \"msg_count_ai\": 0,    // mensajes AI\n  \"msg_count_human\": 0, // mensajes humano\n  \"turn_count\": 0,      // min(msg_count_human, msg_count_ai)\n  \"intent_principal\": \"reservar|modificar_reserva|cancelar_reserva|consultar_disponibilidad|consultar_horarios|consultar_ubicacion|consultar_menu|consultar_promociones|pedido|otro\", // ENUM ¿Cuál es el objetivo dominante del humano?\n  \"intents_secundarios\": [], // array de strings sin duplicados de intenciones secundarias detectadas\n  \"resolution_status\": \"exitoso|fallido|parcial|reservado|modificado|cancelado|informacion_entregada|derivado_humano|abandonado|otro\", // ENUM estado de resolución\n  \"resolution_ok\": \"true|false\", // boolean, si el intento principal se logró\n  \"no_resolution_reason\": \"faltan_datos_cliente|faltan_datos_negocio|error_herramienta|politica_negocio|loop_o_confusion|cliente_no_responde|otro|null\", // null si resolution_ok es true\n  \"reserva_accion\": \"create|modify|cancel|null\",  \n  \"reserva_codigo\": \"string|null\", // ejemplo: \"OSK-250101-XXXX\" \n  \"reserva_fecha\": \"YYYY-MM-DD|null\",\n  \"reserva_hora\": \"HH:MM|HH:MM:SS|null\",\n  \"reserva_pax\": \"number|null\",\n  \"reserva_zona\": \"string|null\",\n  \"cliente_nombre\": \"string|null\",\n  \"confirmacion_explicita\": \"true|false\", // boolean si la IA pide confirmación explícita\n  \"repreguntas_count\": 0, // número de repreguntas sobre datos ya dados\n  \"claridad_siguiente_paso\": \"0|1|2\",\n  \"consistencia_sucursal\": \"true|false|null\",\n  \"friccion_score\": \"0|1|2|3|4|5|6\", // 0 (sin fricción) a 6 (mucha fricción)\n  \"sentiment_inicio\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al inicio de la conversación\n  \"sentiment_final\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al final de la conversación\n  \"tono_ai\": \"cordial|profesional|efusivo|otro\", // etiqueta breve según estilo del bot\n  \"escalado\": \"true|false\", // boolean si hubo escalación a humano\n  \"escalacion_tipo\": \"politica|incertidumbre|error_tecnico|queja|peticion_cliente|loop_conversacional|otro|null\", // null si escalado es false\n  \"escalacion_turno\": \"number|null\", //  null si escalado es false\n  \"handoff_quality\": \"0|1|2|null\", // null si escalado es false\n  \"afirmacion_disponibilidad_sin_fuente\": \"true|false\", // boolean si el bot afirma disponibilidad sin evidencia de consulta a herramienta\n  \"error_detectado\": \"true|false\", // boolean si hay evidencia interna de error/contradicción por parte de la IA\n  \"error_tipo\": \"invento_info|sucursal_incorrecta|fecha_hora_incorrecta|politica_mal_aplicada|contradiccion|otro|null\", // null si error_detectado es false\n  \"riesgo_negocio\": \"high|med|low\", // nivel de riesgo detectado\n  \"improvement_tag\": \"prompt|kb|flujo_preguntas|validaciones_fecha_hora|integracion_calendario|multi_sucursal|tono|seguridad_privacidad|handoff_humano|otro|null\", // null si no aplica\n  \"evidence_message_ids\": [],\n  \"evidence_snippet\": null, // Estrictamente 1-2 líneas <= 250 caracteres, idioma español\n  \"datos_faltantes\": [],\n  \"entidades_json\": { \"extracted\": {}, \"confidence\": {}, \"notes\": [] },\n  \"messages_json\": null,\n  \"analyzed_by\": \"audit-llm-v1\"\n}\n```\n\nVALIDACIONES\n- No uses valores fuera de los ENUMS esperados.\n- Si resolution_ok=true, entonces resolution_status NO puede ser 'fallido'.\n- Si escalado=false, escalacion_tipo/escalacion_turno/handoff_quality deben ser null.\n- evidence_message_ids no puede estar vacío si resolution_ok=true o escalado=true o error_detectado=true.\n- Solo usa el idioma español en todo el output.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -160,
        208
      ],
      "id": "66738309-4fdb-401e-a1d6-f38cafff5712",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -176,
        368
      ],
      "id": "e56f0822-cf26-461e-be99-4fa24333afda",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "OAlDnAQJQHCtNBVS",
          "name": "Google Gemini(PaLM) Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -352,
        208
      ],
      "id": "3807f44c-2f65-4235-b096-a2384d4a9e00",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "jsCode": "// Iteramos sobre todos los items\nreturn items.map(item => {\n  try {\n    // 1. Obtenemos el string\n    let rawContent = item.json.output || \"\";\n\n    // 2. Limpieza de Markdown (Como antes)\n    let cleanContent = rawContent\n      .replace(/^```json\\s*/i, '')\n      .replace(/^```\\s*/i, '')\n      .replace(/\\s*```$/, '')\n      .trim();\n\n    // -----------------------------------------------------------\n    // 3. REPARACIÓN DE JSON ROTO (El Parche)\n    // -----------------------------------------------------------\n    // El error es: cierra una propiedad con \", en lugar de },\n    // Buscamos: Salto de linea (\\n) -> Espacios (\\s*) -> Comilla (\") -> Coma (,)\n    // Y lo reemplazamos por: },\n    // Nota: Usamos una Regex específica para no romper otros textos.\n    \n    cleanContent = cleanContent.replace(/(\\n\\s*)\"\\s*,/g, '$1},');\n\n    // -----------------------------------------------------------\n\n    // 4. Parseo\n    const parsedData = JSON.parse(cleanContent);\n\n    // 5. Retorno Exitoso\n    return {\n      json: parsedData\n    };\n\n  } catch (error) {\n    // Si falla de nuevo, te dará detalles más precisos\n    return {\n      json: {\n        error: true,\n        message: \"Aún fallando el parseo. Revisa 'cleaned_string' para ver el error.\",\n        original_error: error.message,\n        // Devolvemos el string limpio para que veas si el parche funcionó visualmente\n        cleaned_string: error.input_string_debug \n      }\n    };\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        208
      ],
      "id": "a530b6e1-e16c-4b9c-8270-7bb00b56ec21",
      "name": "Normaliza Salida"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "osaki_analytics",
          "mode": "list",
          "cachedResultName": "osaki_analytics"
        },
        "table": {
          "__rl": true,
          "value": "auditoria_conversacion_reservas",
          "mode": "list",
          "cachedResultName": "auditoria_conversacion_reservas"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "resolution_ok": "={{ $json.resolution_ok }}",
            "confirmacion_explicita": "={{ $json.confirmacion_explicita }}",
            "consistencia_sucursal": "={{ $json.consistencia_sucursal }}",
            "escalado": "={{ $json.escalado }}",
            "afirmacion_disponibilidad_sin_fuente": "={{ $json.afirmacion_disponibilidad_sin_fuente }}",
            "error_detectado": "={{ $json.error_detectado }}",
            "channel": "=WhatsApp",
            "agent": "=Restó",
            "brand": "=Osaki",
            "sucursal_detectada": "=Restó Calle 47",
            "first_user_ts": "={{ $json.first_user_ts }}",
            "last_user_ts": "={{ $json.last_user_ts }}",
            "duration_sec": "={{ $json.duration_sec }}",
            "session_count": "={{ $json.session_count }}",
            "session_rule": "={{ $json.session_rule }}",
            "max_gap_minutes": "={{ $json.max_gap_minutes }}",
            "msg_count_total": "={{ $json.msg_count_total }}",
            "msg_count_ai": "={{ $json.msg_count_ai }}",
            "msg_count_human": "={{ $json.msg_count_human }}",
            "turn_count": "={{ $json.turn_count }}",
            "intent_principal": "={{ $json.intent_principal }}",
            "intents_secundarios": "={{ $json.intents_secundarios }}",
            "resolution_status": "={{ $json.resolution_status }}",
            "no_resolution_reason": "={{ $json.no_resolution_reason }}",
            "reserva_accion": "={{ $json.reserva_accion }}",
            "reserva_codigo": "={{ $json.reserva_codigo }}",
            "reserva_fecha": "={{ $json.reserva_fecha }}",
            "reserva_hora": "={{ $json.reserva_hora }}",
            "reserva_pax": "={{ $json.reserva_pax }}",
            "reserva_zona": "={{ $json.reserva_zona }}",
            "cliente_nombre": "={{ $json.cliente_nombre }}",
            "repreguntas_count": "={{ $json.repreguntas_count }}",
            "claridad_siguiente_paso": "={{ $json.claridad_siguiente_paso }}",
            "friccion_score": "={{ $json.friccion_score }}",
            "sentiment_inicio": "={{ $json.sentiment_inicio }}",
            "sentiment_final": "={{ $json.sentiment_final }}",
            "tono_ai": "={{ $json.tono_ai }}",
            "escalacion_tipo": "={{ $json.escalacion_tipo }}",
            "escalacion_turno": "={{ $json.escalacion_turno }}",
            "handoff_quality": "={{ $json.handoff_quality }}",
            "error_tipo": "={{ $json.error_tipo }}",
            "riesgo_negocio": "={{ $json.riesgo_negocio }}",
            "improvement_tag": "={{ $json.improvement_tag }}",
            "evidence_message_ids": "={{ $json.evidence_message_ids }}",
            "evidence_snippet": "={{ $json.evidence_snippet }}",
            "datos_faltantes": "={{ $json.datos_faltantes }}",
            "entidades_json": "={{ $json.entidades_json }}",
            "messages_json": "={{ { \"conversacion\": $('Aggregate').item.json.data } }}",
            "analyzed_by": "={{ $json.analyzed_by }}",
            "analyzed_at": "={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat(\"yyyy-MM-dd'T'HH:mm:ss.000'Z'\") }}",
            "mes_analisis": "={{ $('Initial Data').first().json.mes_anterior }}",
            "session_id": "={{ $('Loop Over Items').item.json.session_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "audit_id",
              "displayName": "audit_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent",
              "displayName": "agent",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "brand",
              "displayName": "brand",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sucursal_detectada",
              "displayName": "sucursal_detectada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_user_ts",
              "displayName": "first_user_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_user_ts",
              "displayName": "last_user_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "duration_sec",
              "displayName": "duration_sec",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_count",
              "displayName": "session_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_rule",
              "displayName": "session_rule",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "max_gap_minutes",
              "displayName": "max_gap_minutes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_total",
              "displayName": "msg_count_total",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_ai",
              "displayName": "msg_count_ai",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_human",
              "displayName": "msg_count_human",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "turn_count",
              "displayName": "turn_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "intent_principal",
              "displayName": "intent_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "reservar",
                  "value": "reservar"
                },
                {
                  "name": "modificar_reserva",
                  "value": "modificar_reserva"
                },
                {
                  "name": "cancelar_reserva",
                  "value": "cancelar_reserva"
                },
                {
                  "name": "consultar_disponibilidad",
                  "value": "consultar_disponibilidad"
                },
                {
                  "name": "consultar_horarios",
                  "value": "consultar_horarios"
                },
                {
                  "name": "consultar_ubicacion",
                  "value": "consultar_ubicacion"
                },
                {
                  "name": "consultar_menu",
                  "value": "consultar_menu"
                },
                {
                  "name": "consultar_promociones",
                  "value": "consultar_promociones"
                },
                {
                  "name": "otro",
                  "value": "otro"
                }
              ]
            },
            {
              "id": "intents_secundarios",
              "displayName": "intents_secundarios",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "resolution_status",
              "displayName": "resolution_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "reservado",
                  "value": "reservado"
                },
                {
                  "name": "modificado",
                  "value": "modificado"
                },
                {
                  "name": "cancelado",
                  "value": "cancelado"
                },
                {
                  "name": "informacion_entregada",
                  "value": "informacion_entregada"
                },
                {
                  "name": "derivado_humano",
                  "value": "derivado_humano"
                },
                {
                  "name": "abandonado",
                  "value": "abandonado"
                },
                {
                  "name": "fallido",
                  "value": "fallido"
                }
              ]
            },
            {
              "id": "resolution_ok",
              "displayName": "resolution_ok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "no_resolution_reason",
              "displayName": "no_resolution_reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "faltan_datos_cliente",
                  "value": "faltan_datos_cliente"
                },
                {
                  "name": "faltan_datos_negocio",
                  "value": "faltan_datos_negocio"
                },
                {
                  "name": "error_herramienta",
                  "value": "error_herramienta"
                },
                {
                  "name": "politica_negocio",
                  "value": "politica_negocio"
                },
                {
                  "name": "loop_o_confusion",
                  "value": "loop_o_confusion"
                },
                {
                  "name": "cliente_no_responde",
                  "value": "cliente_no_responde"
                },
                {
                  "name": "otro",
                  "value": "otro"
                }
              ]
            },
            {
              "id": "reserva_accion",
              "displayName": "reserva_accion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "reserva_codigo",
              "displayName": "reserva_codigo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "reserva_fecha",
              "displayName": "reserva_fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "reserva_hora",
              "displayName": "reserva_hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true
            },
            {
              "id": "reserva_pax",
              "displayName": "reserva_pax",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "reserva_zona",
              "displayName": "reserva_zona",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cliente_nombre",
              "displayName": "cliente_nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirmacion_explicita",
              "displayName": "confirmacion_explicita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "repreguntas_count",
              "displayName": "repreguntas_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "claridad_siguiente_paso",
              "displayName": "claridad_siguiente_paso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "consistencia_sucursal",
              "displayName": "consistencia_sucursal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "friccion_score",
              "displayName": "friccion_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "sentiment_inicio",
              "displayName": "sentiment_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "positivo",
                  "value": "positivo"
                },
                {
                  "name": "neutral",
                  "value": "neutral"
                },
                {
                  "name": "negativo",
                  "value": "negativo"
                },
                {
                  "name": "mixto",
                  "value": "mixto"
                },
                {
                  "name": "desconocido",
                  "value": "desconocido"
                }
              ]
            },
            {
              "id": "sentiment_final",
              "displayName": "sentiment_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "positivo",
                  "value": "positivo"
                },
                {
                  "name": "neutral",
                  "value": "neutral"
                },
                {
                  "name": "negativo",
                  "value": "negativo"
                },
                {
                  "name": "mixto",
                  "value": "mixto"
                },
                {
                  "name": "desconocido",
                  "value": "desconocido"
                }
              ]
            },
            {
              "id": "tono_ai",
              "displayName": "tono_ai",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalado",
              "displayName": "escalado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalacion_tipo",
              "displayName": "escalacion_tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalacion_turno",
              "displayName": "escalacion_turno",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "handoff_quality",
              "displayName": "handoff_quality",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "afirmacion_disponibilidad_sin_fuente",
              "displayName": "afirmacion_disponibilidad_sin_fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_detectado",
              "displayName": "error_detectado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_tipo",
              "displayName": "error_tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "riesgo_negocio",
              "displayName": "riesgo_negocio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "low",
                  "value": "low"
                },
                {
                  "name": "med",
                  "value": "med"
                },
                {
                  "name": "high",
                  "value": "high"
                }
              ]
            },
            {
              "id": "improvement_tag",
              "displayName": "improvement_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "prompt",
                  "value": "prompt"
                },
                {
                  "name": "kb",
                  "value": "kb"
                },
                {
                  "name": "flujo_preguntas",
                  "value": "flujo_preguntas"
                },
                {
                  "name": "validaciones_fecha_hora",
                  "value": "validaciones_fecha_hora"
                },
                {
                  "name": "integracion_calendario",
                  "value": "integracion_calendario"
                },
                {
                  "name": "multi_sucursal",
                  "value": "multi_sucursal"
                },
                {
                  "name": "tono",
                  "value": "tono"
                },
                {
                  "name": "seguridad_privacidad",
                  "value": "seguridad_privacidad"
                },
                {
                  "name": "handoff_humano",
                  "value": "handoff_humano"
                },
                {
                  "name": "otro",
                  "value": "otro"
                }
              ]
            },
            {
              "id": "evidence_message_ids",
              "displayName": "evidence_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "evidence_snippet",
              "displayName": "evidence_snippet",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_faltantes",
              "displayName": "datos_faltantes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "entidades_json",
              "displayName": "entidades_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "messages_json",
              "displayName": "messages_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "analyzed_by",
              "displayName": "analyzed_by",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "analyzed_at",
              "displayName": "analyzed_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes_analisis",
              "displayName": "mes_analisis",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        208
      ],
      "id": "00448d34-2ac5-44dc-9f5c-2b044f834559",
      "name": "Registra Analisis",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1024,
        256
      ],
      "id": "16342940-c9a2-4609-bb5a-88b5902f1fd1",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        720,
        304
      ],
      "id": "1f79f4d8-c8d5-4ed9-894d-de5e03c2e877",
      "name": "Wait",
      "webhookId": "dee12afd-228b-4800-ab81-8167794d8844"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        720,
        704
      ],
      "id": "46f6c52f-ef35-4363-bd41-a44608004693",
      "name": "Wait1",
      "webhookId": "dee12afd-228b-4800-ab81-8167794d8844"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -176,
        1200
      ],
      "id": "5b275b2a-d468-474d-a04d-39b8a39233ff",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "OAlDnAQJQHCtNBVS",
          "name": "Google Gemini(PaLM) Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        720,
        1152
      ],
      "id": "13dd9e18-afc4-4fec-8558-79356f0251c0",
      "name": "Wait2",
      "webhookId": "dee12afd-228b-4800-ab81-8167794d8844"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nSELECT DISTINCT ch.session_id\n       --ch.ultimos_10_numeros\nFROM (\n    SELECT session_id,\n           RIGHT(SPLIT_PART(session_id, '@', 1), 10) as ultimos_10_numeros\n    FROM (\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_47\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n        UNION\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_47_bkup\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n    ) t\n) ch\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM osaki_analytics.auditoria_conversacion_delivery a\n    WHERE a.session_id = ch.session_id\n    AND a.mes_analisis = '{{ $json.mes_anterior }}'\n    and sucursal_detectada = 'Calle 47'\n)\nAND NOT EXISTS (\n    SELECT 1\n    FROM osaki_main.blacklist_phones_calle_47 b\n    WHERE b.phone = ch.ultimos_10_numeros::bigint\n)\nORDER BY ch.session_id ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1264,
        656
      ],
      "id": "4e0f21e5-df98-457a-9a47-b4ac873707ee",
      "name": "Get Session_Ids_Delivery_47",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1024,
        656
      ],
      "id": "a31e5478-6df7-4d19-9883-5fd4f3f0037f",
      "name": "Loop Over Items_Delivery_47"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH raw_messages AS (\n    -- Paso 1: Obtenemos los últimos 10 registros de la tabla principal\n    SELECT \n        id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'main' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_47\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n    UNION \n    -- Paso 2: Obtenemos los últimos 10 registros del backup\n    SELECT \n        old_id as id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'backup' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_47_bkup\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n  ),\ncleaned_content AS (\n    -- Paso 3: Limpiamos el ruido inicial (ej: [Used tools...]) una sola vez\n    SELECT \n        id,\n        type,\n        regexp_replace(raw_content, '^\\[Used tools:.*\\]\\]\\s*', '') AS content\n    FROM raw_messages\n)\n-- Paso 4: Aplicamos la lógica de extracción de fecha y texto final\nSELECT\n    CASE \n        WHEN type = 'human' THEN \n            to_char(\n                to_timestamp(\n                    -- Extraemos la fecha y normalizamos guiones a barras\n                    replace(\n                        substring(content FROM '(?i)fecha\\s*y\\s*hora:\\s*([0-9]{4}[/-][0-9]{2}[/-][0-9]{2}\\s*[0-9]{2}:[0-9]{2}:[0-9]{2})'),\n                        '-', '/'\n                    ), \n                    'YYYY/MM/DD HH24:MI:SS'\n                ), \n                'YYYY/MM/DD HH24:MI:SS'\n            )\n        ELSE NULL \n    END AS fecha_hora,\n    \n    id,\n    type,\n    \n    CASE \n        WHEN type = 'human' THEN \n            trim(\n                regexp_replace(\n                    split_part(content, 'Mensaje de Texto o Descripción:', 2),\n                    '\\s+', ' ', 'g'\n                )\n            )\n        ELSE content \n    END AS content\nFROM cleaned_content\nORDER BY id asc;\n",
        "options": {
          "queryReplacement": "={{ $json.session_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -544,
        576
      ],
      "id": "2ff80863-a3b0-41d1-9779-5925c1464080",
      "name": "Get Conversation_Delivery_47",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -336,
        576
      ],
      "id": "defc7063-7ff7-4410-9620-e6d7a17f53dc",
      "name": "Aggregate_Delivery_47"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify({\n  conversation_id: $('Loop Over Items_Delivery_47').item.json.session_id ,\n  messages: $input.all().map(i => i.json)\n}) }}\n",
        "needsFallback": true,
        "options": {
          "systemMessage": "=ROL\nEres un auditor automático de conversaciones (WhatsApp u otros canales) para un agente de DELIVERY / SEGUIMIENTO DE PEDIDOS.\nTu tarea es analizar una conversación (lista de mensajes) y producir UN ÚNICO JSON con las columnas de la tabla\nosaki_analytics.auditoria_conversacion_delivery.\n\nREGLA CRÍTICA ANTI-ALUCINACIÓN (OBLIGATORIA)\n- Solo puedes afirmar datos explícitos en los mensajes de entrada.\n- Si un dato no aparece o no puede inferirse de forma determinística, usa null (o [] para arreglos) y agrega el nombre del campo a datos_faltantes.\n- No inventes: estado del pedido, ETA/tiempo de entrega, consultas a herramientas/DB, políticas, identidades, ni acciones fuera del texto.\n- Si el bot afirma “tu pedido está en camino / en preparación / llega en X min” y NO existe evidencia en el input de que consultó una herramienta/DB (o que se mostró un resultado explícito),\n  entonces:\n  - afirmacion_estado_sin_fuente = true (si afirma estado)\n  - afirmacion_eta_sin_fuente = true (si afirma ETA/tiempo)\n  - y NO uses ese estado/ETA como verdad: deja pedido_estado=\"desconocido\" y/o pedido_hora=null.\n\nINPUT (FORMATO)\nRecibirás un único JSON con:\n- conversation_id: string\n- (opcional) channel: string\n- (opcional) agent: string\n- (opcional) brand: string\n- messages: array de objetos con:\n  - id: number|string|null\n  - fecha_hora: string|null\n  - type: \"human\" | \"ai\" | \"human_agent\" | otro\n  - content: string\n\nDEFAULTS (solo si NO vienen en input)\n- channel = \"whatsapp\"\n- agent = \"delivery\"\n- brand = null\n\nREGLAS DE CÁLCULO\n\n1) Tiempo y sesiones\n- Parsear timestamps no nulos (si no parsea, tratar como null).\n- first_user_ts: primer timestamp de type='human'\n- last_user_ts: último timestamp de type='human'\n- duration_sec: last_user_ts - first_user_ts (segundos) si ambos existen; si no, null.\n- session_rule (texto fijo): \"gap_human_gt_30m\"\n- session_count: 1 + número de gaps entre mensajes 'human' consecutivos > 30 min. Si no hay ts suficientes, 1.\n- max_gap_minutes: máximo gap (min) entre mensajes 'human' consecutivos. Si no hay ts suficientes, null.\n\n2) Conteos\n- msg_count_total: total mensajes\n- msg_count_ai: count(type='ai')\n- msg_count_human: count(type='human') + count(type='human_agent')\n- turn_count: número de cambios de actor al recorrer mensajes en orden temporal (cada cambio incrementa turno).\n  Si no hay timestamps, usa el orden dado.\n\n3) Intención (texto libre con catálogo recomendado)\nintent_principal: elige 1 (texto). Catálogo recomendado:\n- crear_pedido -> nuevo pedido\n- rastrear_pedido -> estado/ubicación/ETA del pedido\n- modificar_pedido -> cambio en pedido existente\n- cancelar_pedido -> anular pedido existente\n- consultar_menu -> info sobre menú/productos\n- consultar_promociones -> info sobre ofertas/descuentos\n- consultar_horarios -> info sobre horarios de atención\n- consultar_ubicacion -> info sobre dirección/sucursales\n- reservacion_mesa -> reservar mesa en restaurante\n- seguimiento_pedido -> Realizar el seguimiento de un pedido\n- notificacion_pedido -> Notificación del estado de un pedido\n- otro -> no encaja\n- Si no hay intención clara o es ambigua => \"otro\".\n\nintents_secundarios: arreglo de strings (sin duplicar intent_principal). Si no hay, [].\n\n4) Resolución\n- resolution_ok: true si el intent_principal fue exitoso;\n  false si no se logró o quedó inconcluso.\n- resolution_status (texto recomendado):\n  - \"exitoso\" -> si se logró la acción principal (pedido creado/modificado/cancelado o info entregada y humano cierra conforme)\n  - \"parcial\" -> si se logró parcialmente (p.ej. pedido modificado parcialmente)\n  - \"fallido\" -> si no se logró la acción principal\n  - \"derivado_humano\" -> si escaló a humano antes de resolución\n  - \"abandonado\" -> si el humano cierra sin resolución\n  - \"otro\"\n- no_resolution_reason (texto, solo si resolution_ok=false). Catálogo recomendado:\n  - \"faltan_datos_cliente\" -> faltan datos del cliente (nombre, código, etc.)\n  - \"faltan_datos_negocio\" -> faltan datos del negocio (disponibilidad, tiempos, etc.)\n  - \"error_herramienta\" -> error técnico o de integración\n  - \"politica_negocio\" -> política que impide completar acción\n  - \"loop_o_confusion\" -> bucle o confusión en la conversación\n  - \"cliente_no_responde\" -> el cliente no responde o cierra\n  - \"otro\"\n  - null si resolution_ok=true\nSi resolution_ok=true => no_resolution_reason=null y resolution_status NO debe ser \"fallido\".\n\n5) Extracción de entidades (solo si aparecen explícitas)\n- pedido_accion (texto recomendado):\n  - \"create\" | \"track\" | \"modify\" | \"cancel\" | null\n- pedido_codigo: string|null (código/ID explícito)\n- pedido_plataforma (texto recomendado):\n  - \"masdelivery\" | \"pedidosya\" | \"web\" | \"whatsapp\" | \"desconocido\"\n- pedido_tipo_entrega: \"delivery\" | \"retiro\" | null (solo si lo dicen)\n- pedido_estado: texto recomendado:\n  - \"recibido\" | \"en_preparacion\" | \"listo\" | \"en_viaje\" | \"entregado\" | \"cancelado\" | \"desconocido\"\n  Reglas:\n  - Solo usar un estado como verdad si aparece explícito con certeza en el chat (por usuario/humano o por resultado explícito).\n  - Si el AI lo afirma sin fuente: pedido_estado=\"desconocido\" y afirmacion_estado_sin_fuente=true.\n- pedido_fecha: \"YYYY-MM-DD\"|null (si se menciona con certeza)\n- pedido_hora: \"HH:MM\"|\"HH:MM:SS\"|null (si se menciona con certeza)\n- cliente_nombre: string|null (si lo aporta explícitamente)\n- sucursal_detectada: string|null (si se menciona explícitamente)\n\n6) Calidad del flujo\n- confirmacion_explicita:\n  true si existe confirmación explícita de cualquiera de las partes sobre un dato/acción (p.ej. “confirmo”, “ok”, “sí” ante una propuesta concreta).\n- repreguntas_count:\n  cuántas veces la IA pide un dato ya entregado por el humano (código, nombre, plataforma, etc.)\n- claridad_siguiente_paso: 0|1|2\n  - 2: siguiente paso concreto y accionable\n  - 1: hay siguiente paso pero incompleto/ambiguo\n  - 0: no hay\n- friccion_score: 0..5 (enteros)\n  Suma sugerida (cap a 5):\n  +2 queja/enojo (“mal”, “tardan”, insultos)\n  +1 si la IA comete error evidente (fecha/hora/política)\n  +1 confusión (“no entiendo”, “cómo”, “qué hago”)\n  +1 repetición del mismo pedido sin avance\n  +1 conversación larga sin progreso\n- consistencia_sucursal:\n  true si no hay contradicción en sucursal; false si cambia; null si no se menciona.\n\n7) Sentimiento (texto libre con catálogo recomendado)\nsentiment_inicio y sentiment_final (texto recomendado):\n- \"positivo\" | \"neutral\" | \"negativo\" | \"mixto\" | \"desconocido\"\n\n8) Escalación\n- escalado: true si se indica explícitamente que un humano continuará (“te escribe alguien”, “paso a un compañero”, etc.)\n- escalacion_tipo (texto recomendado): \n  \"politica\" | \"incertidumbre\" | \"error_tecnico\" | \"queja\" | \"peticion_cliente\" | \"loop_conversacional\" | \"otro\" | null\n- escalacion_turno: integer|null (turno donde ocurre primera mención de escalación)\n- handoff_quality: 0|1|2|null\n  - 2: resumen + datos clave + siguiente paso claro\n  - 1: parcial\n  - 0: sin contexto\nRegla:\n- Si escalado=false => escalacion_tipo=null, escalacion_turno=null, handoff_quality=null.\n\n9) Veracidad / errores\n- error_detectado: true SOLO si hay evidencia clara de error/bucle/contradicción.\n- error_tipo (texto recomendado):\n  \"invento_info\" | \"estado_inventado\" | \"eta_inventado\" | \"politica_mal_aplicada\" | \"contradiccion\" | \"loop\" | \"otro\" | null\n\n10) Riesgo / mejoras (texto libre)\n- riesgo_negocio: \"low\" | \"med\" | \"high\" (recomendado)\n- improvement_tag: string|null (texto libre; usa tags consistentes, p.ej. \"kb\", \"flujo_preguntas\", \"handoff_humano\", etc.)\n\n11) Evidencia\n- evidence_message_ids:\n  lista de 2 a 6 ids que sustenten intent, resolución, escalación o error. Si no hay ids, [].\nRegla:\n- Si resolution_ok=true o escalado=true o error_detectado=true => evidence_message_ids NO debe ser [].\n- evidence_snippet:\n  1-2 líneas <= 250 caracteres con extracto mínimo (sin inventar).\n- datos_faltantes:\n  arreglo de strings con campos relevantes que quedaron null/[] por falta de evidencia.\n\n12) entidades_json (jsonb)\nEstructura mínima:\n{\n  \"extracted\": { ... },\n  \"confidence\": { \"campo\": 0.0-1.0, ... },\n  \"notes\": [ ... ]\n}\n\nSALIDA (FORMATO ESTRICTO)\nResponde EXCLUSIVAMENTE con UN ÚNICO JSON válido, sin markdown, sin comentarios, sin texto adicional.\nLas claves deben coincidir EXACTAMENTE con las columnas de osaki_analytics.auditoria_conversacion_delivery:\n\n```json\n{\n  \"conversation_id\": \"string\",\n  \"channel\": \"string\",\n  \"agent\": \"string\",\n  \"brand\": \"string|null\",\n  \"sucursal_detectada\": \"string|null\",\n\n  \"first_user_ts\": \"timestamp|null\",  // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"last_user_ts\": \"timestamp|null\",   // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"duration_sec\": \"number|null\", // número entero >=0\n\n  \"session_count\": 1, // número de sesiones detectadas\n  \"session_rule\": \"gap_human_gt_30m\", \n  \"max_gap_minutes\": \"number|null\", // número entero >=0\n\n  \"msg_count_total\": 0, // número de mensajes en total\n  \"msg_count_ai\": 0, // número de mensajes del AI\n  \"msg_count_human\": 0, // número de mensajes del humano\n  \"turn_count\": 0,  // min(msg_count_human, msg_count_ai)\n\n  \"intent_principal\": \"crear_pedido|rastrear_pedido|modificar_pedido|cancelar_pedido|consultar_menu|consultar_promociones|consultar_horarios|consultar_ubicacion|reservacion_mesa|seguimiento_pedido|notificacion_pedido|otro\",  //  ENUM ¿Cuál es el objetivo dominante del humano?\n  \"intents_secundarios\": [],  // arreglo de strings (sin duplicar intent_principal). Si no hay, []\n\n  \"resolution_status\": \"exitoso|parcial|fallido|derivado_humano|abandonado|otro\", // estado de resolución del intent principal\n  \"resolution_ok\": \"true|false\", // boolean, si el intento principal se logró\n  \"no_resolution_reason\": \"faltan_datos_cliente|faltan_datos_negocio|error_herramienta|politica_negocio|loop_o_confusion|cliente_no_responde|otro|null\", // null si resolution_ok es true\n\n  \"pedido_accion\": \"create|track|modify|cancel|null\", // Si hay un pedido explícito\n  \"pedido_codigo\": \"string|null\",\n  \"pedido_plataforma\": \"masdelivery|pedidosya|web|whatsapp|desconocido\",\n  \"pedido_tipo_entrega\": \"delivery|retiro|null\",\n  \"pedido_estado\": \"string\",\n  \"pedido_fecha\": \"YYYY-MM-DD|null\",\n  \"pedido_hora\": \"HH:MM|HH:MM:SS|null\",\n\n  \"cliente_nombre\": \"string|null\",\n\n  \"confirmacion_explicita\": \"true|false\", // boolean si la IA pide confirmación explícita\n  \"repreguntas_count\": 0, // número de repreguntas sobre datos ya dados\n  \"claridad_siguiente_paso\": \"0|1|2\",  // 0: no hay; 1: ambiguo/incompleto; 2: claro\n  \"consistencia_sucursal\": \"true|false|null\", // null si no se menciona\n  \"friccion_score\": \"0|1|2|3|4|5|6\", // 0 (sin fricción) a 6 (mucha fricción)\n\n  \"sentiment_inicio\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al inicio de la conversación\n  \"sentiment_final\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al final de la conversación\n  \"tono_ai\": \"cordial|profesional|efusivo|otro\", // etiqueta breve según estilo del bot\n\n  \"escalado\": \"true|false\", // boolean si hubo escalación a humano\n  \"escalacion_tipo\": \"politica|incertidumbre|error_tecnico|queja|peticion_cliente|loop_conversacional|otro|null\", // null si escalado es false\n  \"escalacion_turno\": \"number|null\", //  null si escalado es false\n  \"handoff_quality\": \"number|null\",\n\n  \"afirmacion_estado_sin_fuente\": \"true|false\", // boolean si el bot afirma estado sin evidencia de consulta a herramienta\n  \"afirmacion_eta_sin_fuente\": \"true|false\", // boolean si el bot afirma ETA sin evidencia de consulta a herramienta\n\n  \"error_detectado\": \"true|false\", // boolean si hay evidencia interna de error/contradicción por parte de la IA\n  \"error_tipo\": \"invento_info|estado_inventado|eta_inventado|politica_mal_aplicada|contradiccion|loop|otro|null\", // null si error_detectado es false\n\n  \"riesgo_negocio\": \"high|med|low\", // nivel de riesgo detectado\n  \"improvement_tag\": \"prompt|kb|flujo_preguntas|validaciones_fecha_hora|integracion_calendario|multi_sucursal|tono|seguridad_privacidad|handoff_humano|otro|null\", // null si no aplica\n\n  \"evidence_message_ids\": [],\n  \"evidence_snippet\": \"string|null\",\n  \"datos_faltantes\": [],\n\n  \"entidades_json\": { \"extracted\": {}, \"confidence\": {}, \"notes\": [] },\n  \"messages_json\": null,\n\n  \"analyzed_by\": \"audit-llm-delivery-v1\"\n}\n```\n\nVALIDACIONES FINALES (OBLIGATORIAS)\n- No “rellenes” con suposiciones: si falta evidencia => null/[] + datos_faltantes.\n- Si resolution_ok=true => resolution_status != \"fallido\" y no_resolution_reason=null.\n- Si escalado=false => escalacion_* = null y handoff_quality=null.\n- Si (resolution_ok=true) OR (escalado=true) OR (error_detectado=true) => evidence_message_ids no puede ser [].\n- Usa español.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -144,
        576
      ],
      "id": "87794200-9c56-40ed-8ebb-a3f2cbb7a532",
      "name": "AI Agent_Delivery_47"
    },
    {
      "parameters": {
        "jsCode": "// Iteramos sobre todos los items\nreturn items.map(item => {\n  try {\n    // 1. Obtenemos el string\n    let rawContent = item.json.output || \"\";\n\n    // 2. Limpieza de Markdown (Como antes)\n    let cleanContent = rawContent\n      .replace(/^```json\\s*/i, '')\n      .replace(/^```\\s*/i, '')\n      .replace(/\\s*```$/, '')\n      .trim();\n\n    // -----------------------------------------------------------\n    // 3. REPARACIÓN DE JSON ROTO (El Parche)\n    // -----------------------------------------------------------\n    // El error es: cierra una propiedad con \", en lugar de },\n    // Buscamos: Salto de linea (\\n) -> Espacios (\\s*) -> Comilla (\") -> Coma (,)\n    // Y lo reemplazamos por: },\n    // Nota: Usamos una Regex específica para no romper otros textos.\n    \n    cleanContent = cleanContent.replace(/(\\n\\s*)\"\\s*,/g, '$1},');\n\n    // -----------------------------------------------------------\n\n    // 4. Parseo\n    const parsedData = JSON.parse(cleanContent);\n\n    // 5. Retorno Exitoso\n    return {\n      json: parsedData\n    };\n\n  } catch (error) {\n    // Si falla de nuevo, te dará detalles más precisos\n    return {\n      json: {\n        error: true,\n        message: \"Aún fallando el parseo. Revisa 'cleaned_string' para ver el error.\",\n        original_error: error.message,\n        // Devolvemos el string limpio para que veas si el parche funcionó visualmente\n        cleaned_string: error.input_string_debug \n      }\n    };\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        576
      ],
      "id": "982df9e6-d96a-4c89-b820-01869ffa687d",
      "name": "Normaliza Salida_Delivery_47"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "osaki_analytics",
          "mode": "list",
          "cachedResultName": "osaki_analytics"
        },
        "table": {
          "__rl": true,
          "value": "auditoria_conversacion_delivery",
          "mode": "list",
          "cachedResultName": "auditoria_conversacion_delivery"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "resolution_ok": "={{ $json.resolution_ok }}",
            "confirmacion_explicita": "={{ $json.confirmacion_explicita }}",
            "consistencia_sucursal": "={{ $json.consistencia_sucursal }}",
            "escalado": "={{ $json.escalado }}",
            "afirmacion_estado_sin_fuente": "={{ $json.afirmacion_estado_sin_fuente }}",
            "afirmacion_eta_sin_fuente": "={{ $json.afirmacion_eta_sin_fuente }}",
            "error_detectado": "={{ $json.error_detectado }}",
            "channel": "WhatsApp",
            "agent": "Delivery",
            "brand": "Osaki",
            "sucursal_detectada": "Calle 47",
            "first_user_ts": "={{ $json.first_user_ts }}",
            "last_user_ts": "={{ $json.last_user_ts }}",
            "duration_sec": "={{ $json.duration_sec }}",
            "session_count": "={{ $json.session_count }}",
            "session_rule": "={{ $json.session_rule }}",
            "max_gap_minutes": "={{ $json.max_gap_minutes }}",
            "msg_count_total": "={{ $json.msg_count_total }}",
            "msg_count_ai": "={{ $json.msg_count_ai }}",
            "msg_count_human": "={{ $json.msg_count_human }}",
            "turn_count": "={{ $json.turn_count }}",
            "intent_principal": "={{ $json.intent_principal }}",
            "intents_secundarios": "={{ $json.intents_secundarios }}",
            "resolution_status": "={{ $json.resolution_status }}",
            "no_resolution_reason": "={{ $json.no_resolution_reason }}",
            "pedido_accion": "={{ $json.pedido_accion }}",
            "pedido_codigo": "={{ $json.pedido_codigo }}",
            "pedido_plataforma": "={{ $json.pedido_plataforma }}",
            "pedido_tipo_entrega": "={{ $json.pedido_tipo_entrega }}",
            "pedido_estado": "={{ $json.pedido_estado }}",
            "pedido_fecha": "={{ $json.pedido_fecha }}",
            "pedido_hora": "={{ $json.pedido_hora }}",
            "cliente_nombre": "={{ $json.cliente_nombre }}",
            "repreguntas_count": "={{ $json.repreguntas_count }}",
            "claridad_siguiente_paso": "={{ $json.claridad_siguiente_paso }}",
            "friccion_score": "={{ $json.friccion_score }}",
            "sentiment_inicio": "={{ $json.sentiment_inicio }}",
            "sentiment_final": "={{ $json.sentiment_final }}",
            "tono_ai": "={{ $json.tono_ai }}",
            "escalacion_tipo": "={{ $json.escalacion_tipo }}",
            "escalacion_turno": "={{ $json.escalacion_turno }}",
            "handoff_quality": "={{ $json.handoff_quality }}",
            "error_tipo": "={{ $json.error_tipo }}",
            "riesgo_negocio": "={{ $json.riesgo_negocio }}",
            "improvement_tag": "={{ $json.improvement_tag }}",
            "evidence_message_ids": "={{ $json.evidence_message_ids }}",
            "evidence_snippet": "={{ $json.evidence_snippet }}",
            "datos_faltantes": "={{ $json.datos_faltantes }}",
            "entidades_json": "={{ $json.entidades_json }}",
            "analyzed_by": "={{ $json.analyzed_by }}",
            "messages_json": "={{ { \"conversacion\": $('Aggregate_Delivery_47').item.json.data } }}",
            "analyzed_at": "={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat(\"yyyy-MM-dd'T'HH:mm:ss.000'Z'\") }}",
            "session_id": "={{ $('Loop Over Items_Delivery_47').item.json.session_id }}",
            "mes_analisis": "={{ $('Initial Data').first().json.mes_anterior }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "audit_id",
              "displayName": "audit_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent",
              "displayName": "agent",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "brand",
              "displayName": "brand",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sucursal_detectada",
              "displayName": "sucursal_detectada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_user_ts",
              "displayName": "first_user_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_user_ts",
              "displayName": "last_user_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "duration_sec",
              "displayName": "duration_sec",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_count",
              "displayName": "session_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_rule",
              "displayName": "session_rule",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "max_gap_minutes",
              "displayName": "max_gap_minutes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_total",
              "displayName": "msg_count_total",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_ai",
              "displayName": "msg_count_ai",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_human",
              "displayName": "msg_count_human",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "turn_count",
              "displayName": "turn_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "intent_principal",
              "displayName": "intent_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "intents_secundarios",
              "displayName": "intents_secundarios",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "resolution_status",
              "displayName": "resolution_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "resolution_ok",
              "displayName": "resolution_ok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "no_resolution_reason",
              "displayName": "no_resolution_reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_accion",
              "displayName": "pedido_accion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_codigo",
              "displayName": "pedido_codigo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_plataforma",
              "displayName": "pedido_plataforma",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_tipo_entrega",
              "displayName": "pedido_tipo_entrega",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_estado",
              "displayName": "pedido_estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_fecha",
              "displayName": "pedido_fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_hora",
              "displayName": "pedido_hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true
            },
            {
              "id": "cliente_nombre",
              "displayName": "cliente_nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirmacion_explicita",
              "displayName": "confirmacion_explicita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "repreguntas_count",
              "displayName": "repreguntas_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "claridad_siguiente_paso",
              "displayName": "claridad_siguiente_paso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "consistencia_sucursal",
              "displayName": "consistencia_sucursal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "friccion_score",
              "displayName": "friccion_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "sentiment_inicio",
              "displayName": "sentiment_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sentiment_final",
              "displayName": "sentiment_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tono_ai",
              "displayName": "tono_ai",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalado",
              "displayName": "escalado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalacion_tipo",
              "displayName": "escalacion_tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalacion_turno",
              "displayName": "escalacion_turno",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "handoff_quality",
              "displayName": "handoff_quality",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "afirmacion_estado_sin_fuente",
              "displayName": "afirmacion_estado_sin_fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "afirmacion_eta_sin_fuente",
              "displayName": "afirmacion_eta_sin_fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_detectado",
              "displayName": "error_detectado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_tipo",
              "displayName": "error_tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "riesgo_negocio",
              "displayName": "riesgo_negocio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "improvement_tag",
              "displayName": "improvement_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "evidence_message_ids",
              "displayName": "evidence_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "evidence_snippet",
              "displayName": "evidence_snippet",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_faltantes",
              "displayName": "datos_faltantes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "entidades_json",
              "displayName": "entidades_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "messages_json",
              "displayName": "messages_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "analyzed_by",
              "displayName": "analyzed_by",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "analyzed_at",
              "displayName": "analyzed_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes_analisis",
              "displayName": "mes_analisis",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        576
      ],
      "id": "3bb68151-212b-4354-aef0-3034d2d6db5b",
      "name": "Registra Analisis_Delivery_47",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nSELECT DISTINCT ch.session_id\n       --ch.ultimos_10_numeros\nFROM (\n    SELECT session_id,\n           RIGHT(SPLIT_PART(session_id, '@', 1), 10) as ultimos_10_numeros\n    FROM (\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_9\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n        UNION\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_delivery_calle_9_bkup\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n    ) t\n) ch\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM osaki_analytics.auditoria_conversacion_delivery a\n    WHERE a.session_id = ch.session_id\n    AND a.mes_analisis = '{{ $json.mes_anterior }}'\n    and sucursal_detectada = 'Calle 9'\n)\nAND NOT EXISTS (\n    SELECT 1\n    FROM osaki_main.blacklist_phones_calle_9 b\n    WHERE b.phone = ch.ultimos_10_numeros::bigint\n)\nORDER BY ch.session_id ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1248,
        1104
      ],
      "id": "f49a3f51-a425-4b68-baf8-3f9c6ac1178f",
      "name": "Get Session_Ids_Delivery_9",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1024,
        1104
      ],
      "id": "3997c204-010a-47d5-be2c-33f8575cc613",
      "name": "Loop Over Items_Delivery_9"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH raw_messages AS (\n    -- Paso 1: Obtenemos los últimos 10 registros de la tabla principal\n    SELECT \n        id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'main' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_9\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n    UNION \n    -- Paso 2: Obtenemos los últimos 10 registros del backup\n    SELECT \n        old_id as id, \n        message->>'type' as type, \n        message->>'content' as raw_content,\n        'backup' as source\n    FROM osaki_main.n8n_chat_histories_delivery_calle_9_bkup\n    WHERE session_id = $1\n    AND fec_registro BETWEEN '{{ $('Initial Data').first().json.fec_initial }}' AND '{{ $('Initial Data').first().json.fec_final }}'\n    \n  ),\ncleaned_content AS (\n    -- Paso 3: Limpiamos el ruido inicial (ej: [Used tools...]) una sola vez\n    SELECT \n        id,\n        type,\n        regexp_replace(raw_content, '^\\[Used tools:.*\\]\\]\\s*', '') AS content\n    FROM raw_messages\n)\n-- Paso 4: Aplicamos la lógica de extracción de fecha y texto final\nSELECT\n    CASE \n        WHEN type = 'human' THEN \n            to_char(\n                to_timestamp(\n                    -- Extraemos la fecha y normalizamos guiones a barras\n                    replace(\n                        substring(content FROM '(?i)fecha\\s*y\\s*hora:\\s*([0-9]{4}[/-][0-9]{2}[/-][0-9]{2}\\s*[0-9]{2}:[0-9]{2}:[0-9]{2})'),\n                        '-', '/'\n                    ), \n                    'YYYY/MM/DD HH24:MI:SS'\n                ), \n                'YYYY/MM/DD HH24:MI:SS'\n            )\n        ELSE NULL \n    END AS fecha_hora,\n    \n    id,\n    type,\n    \n    CASE \n        WHEN type = 'human' THEN \n            trim(\n                regexp_replace(\n                    split_part(content, 'Mensaje de Texto o Descripción:', 2),\n                    '\\s+', ' ', 'g'\n                )\n            )\n        ELSE content \n    END AS content\nFROM cleaned_content\nORDER BY id asc;\n",
        "options": {
          "queryReplacement": "={{ $json.session_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -544,
        1056
      ],
      "id": "08202f9c-1a48-4372-bba4-0d2907ef8d0d",
      "name": "Get Conversation_Delivery_9",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -336,
        1056
      ],
      "id": "ebb143a5-c553-4f18-882d-3594f036082a",
      "name": "Aggregate_Delivery_9"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify({\n  conversation_id: $('Loop Over Items_Delivery_9').item.json.session_id ,\n  messages: $input.all().map(i => i.json)\n}) }}\n",
        "options": {
          "systemMessage": "=ROL\nEres un auditor automático de conversaciones (WhatsApp u otros canales) para un agente de DELIVERY / SEGUIMIENTO DE PEDIDOS.\nTu tarea es analizar una conversación (lista de mensajes) y producir UN ÚNICO JSON con las columnas de la tabla\nosaki_analytics.auditoria_conversacion_delivery.\n\nREGLA CRÍTICA ANTI-ALUCINACIÓN (OBLIGATORIA)\n- Solo puedes afirmar datos explícitos en los mensajes de entrada.\n- Si un dato no aparece o no puede inferirse de forma determinística, usa null (o [] para arreglos) y agrega el nombre del campo a datos_faltantes.\n- No inventes: estado del pedido, ETA/tiempo de entrega, consultas a herramientas/DB, políticas, identidades, ni acciones fuera del texto.\n- Si el bot afirma “tu pedido está en camino / en preparación / llega en X min” y NO existe evidencia en el input de que consultó una herramienta/DB (o que se mostró un resultado explícito),\n  entonces:\n  - afirmacion_estado_sin_fuente = true (si afirma estado)\n  - afirmacion_eta_sin_fuente = true (si afirma ETA/tiempo)\n  - y NO uses ese estado/ETA como verdad: deja pedido_estado=\"desconocido\" y/o pedido_hora=null.\n\nINPUT (FORMATO)\nRecibirás un único JSON con:\n- conversation_id: string\n- (opcional) channel: string\n- (opcional) agent: string\n- (opcional) brand: string\n- messages: array de objetos con:\n  - id: number|string|null\n  - fecha_hora: string|null\n  - type: \"human\" | \"ai\" | \"human_agent\" | otro\n  - content: string\n\nDEFAULTS (solo si NO vienen en input)\n- channel = \"whatsapp\"\n- agent = \"delivery\"\n- brand = null\n\nREGLAS DE CÁLCULO\n\n1) Tiempo y sesiones\n- Parsear timestamps no nulos (si no parsea, tratar como null).\n- first_user_ts: primer timestamp de type='human'\n- last_user_ts: último timestamp de type='human'\n- duration_sec: last_user_ts - first_user_ts (segundos) si ambos existen; si no, null.\n- session_rule (texto fijo): \"gap_human_gt_30m\"\n- session_count: 1 + número de gaps entre mensajes 'human' consecutivos > 30 min. Si no hay ts suficientes, 1.\n- max_gap_minutes: máximo gap (min) entre mensajes 'human' consecutivos. Si no hay ts suficientes, null.\n\n2) Conteos\n- msg_count_total: total mensajes\n- msg_count_ai: count(type='ai')\n- msg_count_human: count(type='human') + count(type='human_agent')\n- turn_count: número de cambios de actor al recorrer mensajes en orden temporal (cada cambio incrementa turno).\n  Si no hay timestamps, usa el orden dado.\n\n3) Intención (texto libre con catálogo recomendado)\nintent_principal: elige 1 (texto). Catálogo recomendado:\n- crear_pedido -> nuevo pedido\n- rastrear_pedido -> estado/ubicación/ETA del pedido\n- modificar_pedido -> cambio en pedido existente\n- cancelar_pedido -> anular pedido existente\n- consultar_menu -> info sobre menú/productos\n- consultar_promociones -> info sobre ofertas/descuentos\n- consultar_horarios -> info sobre horarios de atención\n- consultar_ubicacion -> info sobre dirección/sucursales\n- reservacion_mesa -> reservar mesa en restaurante\n- seguimiento_pedido -> Realizar el seguimiento de un pedido\n- notificacion_pedido -> Notificación del estado de un pedido\n- otro -> no encaja\n- Si no hay intención clara o es ambigua => \"otro\".\n\nintents_secundarios: arreglo de strings (sin duplicar intent_principal). Si no hay, [].\n\n4) Resolución\n- resolution_ok: true si el intent_principal fue exitoso;\n  false si no se logró o quedó inconcluso.\n- resolution_status (texto recomendado):\n  - \"exitoso\" -> si se logró la acción principal (pedido creado/modificado/cancelado o info entregada y humano cierra conforme)\n  - \"parcial\" -> si se logró parcialmente (p.ej. pedido modificado parcialmente)\n  - \"fallido\" -> si no se logró la acción principal\n  - \"derivado_humano\" -> si escaló a humano antes de resolución\n  - \"abandonado\" -> si el humano cierra sin resolución\n  - \"otro\"\n- no_resolution_reason (texto, solo si resolution_ok=false). Catálogo recomendado:\n  - \"faltan_datos_cliente\" -> faltan datos del cliente (nombre, código, etc.)\n  - \"faltan_datos_negocio\" -> faltan datos del negocio (disponibilidad, tiempos, etc.)\n  - \"error_herramienta\" -> error técnico o de integración\n  - \"politica_negocio\" -> política que impide completar acción\n  - \"loop_o_confusion\" -> bucle o confusión en la conversación\n  - \"cliente_no_responde\" -> el cliente no responde o cierra\n  - \"otro\"\n  - null si resolution_ok=true\nSi resolution_ok=true => no_resolution_reason=null y resolution_status NO debe ser \"fallido\".\n\n5) Extracción de entidades (solo si aparecen explícitas)\n- pedido_accion (texto recomendado):\n  - \"create\" | \"track\" | \"modify\" | \"cancel\" | null\n- pedido_codigo: string|null (código/ID explícito)\n- pedido_plataforma (texto recomendado):\n  - \"masdelivery\" | \"pedidosya\" | \"web\" | \"whatsapp\" | \"desconocido\"\n- pedido_tipo_entrega: \"delivery\" | \"retiro\" | null (solo si lo dicen)\n- pedido_estado: texto recomendado:\n  - \"recibido\" | \"en_preparacion\" | \"listo\" | \"en_viaje\" | \"entregado\" | \"cancelado\" | \"desconocido\"\n  Reglas:\n  - Solo usar un estado como verdad si aparece explícito con certeza en el chat (por usuario/humano o por resultado explícito).\n  - Si el AI lo afirma sin fuente: pedido_estado=\"desconocido\" y afirmacion_estado_sin_fuente=true.\n- pedido_fecha: \"YYYY-MM-DD\"|null (si se menciona con certeza)\n- pedido_hora: \"HH:MM\"|\"HH:MM:SS\"|null (si se menciona con certeza)\n- cliente_nombre: string|null (si lo aporta explícitamente)\n- sucursal_detectada: string|null (si se menciona explícitamente)\n\n6) Calidad del flujo\n- confirmacion_explicita:\n  true si existe confirmación explícita de cualquiera de las partes sobre un dato/acción (p.ej. “confirmo”, “ok”, “sí” ante una propuesta concreta).\n- repreguntas_count:\n  cuántas veces la IA pide un dato ya entregado por el humano (código, nombre, plataforma, etc.)\n- claridad_siguiente_paso: 0|1|2\n  - 2: siguiente paso concreto y accionable\n  - 1: hay siguiente paso pero incompleto/ambiguo\n  - 0: no hay\n- friccion_score: 0..5 (enteros)\n  Suma sugerida (cap a 5):\n  +2 queja/enojo (“mal”, “tardan”, insultos)\n  +1 si la IA comete error evidente (fecha/hora/política)\n  +1 confusión (“no entiendo”, “cómo”, “qué hago”)\n  +1 repetición del mismo pedido sin avance\n  +1 conversación larga sin progreso\n- consistencia_sucursal:\n  true si no hay contradicción en sucursal; false si cambia; null si no se menciona.\n\n7) Sentimiento (texto libre con catálogo recomendado)\nsentiment_inicio y sentiment_final (texto recomendado):\n- \"positivo\" | \"neutral\" | \"negativo\" | \"mixto\" | \"desconocido\"\n\n8) Escalación\n- escalado: true si se indica explícitamente que un humano continuará (“te escribe alguien”, “paso a un compañero”, etc.)\n- escalacion_tipo (texto recomendado): \n  \"politica\" | \"incertidumbre\" | \"error_tecnico\" | \"queja\" | \"peticion_cliente\" | \"loop_conversacional\" | \"otro\" | null\n- escalacion_turno: integer|null (turno donde ocurre primera mención de escalación)\n- handoff_quality: 0|1|2|null\n  - 2: resumen + datos clave + siguiente paso claro\n  - 1: parcial\n  - 0: sin contexto\nRegla:\n- Si escalado=false => escalacion_tipo=null, escalacion_turno=null, handoff_quality=null.\n\n9) Veracidad / errores\n- error_detectado: true SOLO si hay evidencia clara de error/bucle/contradicción.\n- error_tipo (texto recomendado):\n  \"invento_info\" | \"estado_inventado\" | \"eta_inventado\" | \"politica_mal_aplicada\" | \"contradiccion\" | \"loop\" | \"otro\" | null\n\n10) Riesgo / mejoras (texto libre)\n- riesgo_negocio: \"low\" | \"med\" | \"high\" (recomendado)\n- improvement_tag: string|null (texto libre; usa tags consistentes, p.ej. \"kb\", \"flujo_preguntas\", \"handoff_humano\", etc.)\n\n11) Evidencia\n- evidence_message_ids:\n  lista de 2 a 6 ids que sustenten intent, resolución, escalación o error. Si no hay ids, [].\nRegla:\n- Si resolution_ok=true o escalado=true o error_detectado=true => evidence_message_ids NO debe ser [].\n- evidence_snippet:\n  1-2 líneas <= 250 caracteres con extracto mínimo (sin inventar).\n- datos_faltantes:\n  arreglo de strings con campos relevantes que quedaron null/[] por falta de evidencia.\n\n12) entidades_json (jsonb)\nEstructura mínima:\n{\n  \"extracted\": { ... },\n  \"confidence\": { \"campo\": 0.0-1.0, ... },\n  \"notes\": [ ... ]\n}\n\nSALIDA (FORMATO ESTRICTO)\nResponde EXCLUSIVAMENTE con UN ÚNICO JSON válido, sin markdown, sin comentarios, sin texto adicional.\nLas claves deben coincidir EXACTAMENTE con las columnas de osaki_analytics.auditoria_conversacion_delivery:\n\n```json\n{\n  \"conversation_id\": \"string\",\n  \"channel\": \"string\",\n  \"agent\": \"string\",\n  \"brand\": \"string|null\",\n  \"sucursal_detectada\": \"string|null\",\n\n  \"first_user_ts\": \"timestamp|null\",  // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"last_user_ts\": \"timestamp|null\",   // ISO 8601 \"YYYY-MM-DDTHH:MM:SSZ\" o null\n  \"duration_sec\": \"number|null\", // número entero >=0\n\n  \"session_count\": 1, // número de sesiones detectadas\n  \"session_rule\": \"gap_human_gt_30m\", \n  \"max_gap_minutes\": \"number|null\", // número entero >=0\n\n  \"msg_count_total\": 0, // número de mensajes en total\n  \"msg_count_ai\": 0, // número de mensajes del AI\n  \"msg_count_human\": 0, // número de mensajes del humano\n  \"turn_count\": 0,  // min(msg_count_human, msg_count_ai)\n\n  \"intent_principal\": \"crear_pedido|rastrear_pedido|modificar_pedido|cancelar_pedido|consultar_menu|consultar_promociones|consultar_horarios|consultar_ubicacion|reservacion_mesa|seguimiento_pedido|notificacion_pedido|otro\",  //  ENUM ¿Cuál es el objetivo dominante del humano?\n  \"intents_secundarios\": [],  // arreglo de strings (sin duplicar intent_principal). Si no hay, []\n\n  \"resolution_status\": \"exitoso|parcial|fallido|derivado_humano|abandonado|otro\", // estado de resolución del intent principal\n  \"resolution_ok\": \"true|false\", // boolean, si el intento principal se logró\n  \"no_resolution_reason\": \"faltan_datos_cliente|faltan_datos_negocio|error_herramienta|politica_negocio|loop_o_confusion|cliente_no_responde|otro|null\", // null si resolution_ok es true\n\n  \"pedido_accion\": \"create|track|modify|cancel|null\", // Si hay un pedido explícito\n  \"pedido_codigo\": \"string|null\",\n  \"pedido_plataforma\": \"masdelivery|pedidosya|web|whatsapp|desconocido\",\n  \"pedido_tipo_entrega\": \"delivery|retiro|null\",\n  \"pedido_estado\": \"string\",\n  \"pedido_fecha\": \"YYYY-MM-DD|null\",\n  \"pedido_hora\": \"HH:MM|HH:MM:SS|null\",\n\n  \"cliente_nombre\": \"string|null\",\n\n  \"confirmacion_explicita\": \"true|false\", // boolean si la IA pide confirmación explícita\n  \"repreguntas_count\": 0, // número de repreguntas sobre datos ya dados\n  \"claridad_siguiente_paso\": \"0|1|2\",  // 0: no hay; 1: ambiguo/incompleto; 2: claro\n  \"consistencia_sucursal\": \"true|false|null\", // null si no se menciona\n  \"friccion_score\": \"0|1|2|3|4|5|6\", // 0 (sin fricción) a 6 (mucha fricción)\n\n  \"sentiment_inicio\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al inicio de la conversación\n  \"sentiment_final\": \"positivo|neutral|negativo|mixto|desconocido\", // según señales textuales del HUMANO al final de la conversación\n  \"tono_ai\": \"cordial|profesional|efusivo|otro\", // etiqueta breve según estilo del bot\n\n  \"escalado\": \"true|false\", // boolean si hubo escalación a humano\n  \"escalacion_tipo\": \"politica|incertidumbre|error_tecnico|queja|peticion_cliente|loop_conversacional|otro|null\", // null si escalado es false\n  \"escalacion_turno\": \"number|null\", //  null si escalado es false\n  \"handoff_quality\": \"number|null\",\n\n  \"afirmacion_estado_sin_fuente\": \"true|false\", // boolean si el bot afirma estado sin evidencia de consulta a herramienta\n  \"afirmacion_eta_sin_fuente\": \"true|false\", // boolean si el bot afirma ETA sin evidencia de consulta a herramienta\n\n  \"error_detectado\": \"true|false\", // boolean si hay evidencia interna de error/contradicción por parte de la IA\n  \"error_tipo\": \"invento_info|estado_inventado|eta_inventado|politica_mal_aplicada|contradiccion|loop|otro|null\", // null si error_detectado es false\n\n  \"riesgo_negocio\": \"high|med|low\", // nivel de riesgo detectado\n  \"improvement_tag\": \"prompt|kb|flujo_preguntas|validaciones_fecha_hora|integracion_calendario|multi_sucursal|tono|seguridad_privacidad|handoff_humano|otro|null\", // null si no aplica\n\n  \"evidence_message_ids\": [],\n  \"evidence_snippet\": \"string|null\",\n  \"datos_faltantes\": [],\n\n  \"entidades_json\": { \"extracted\": {}, \"confidence\": {}, \"notes\": [] },\n  \"messages_json\": null,\n\n  \"analyzed_by\": \"audit-llm-delivery-v1\"\n}\n```\n\nVALIDACIONES FINALES (OBLIGATORIAS)\n- No “rellenes” con suposiciones: si falta evidencia => null/[] + datos_faltantes.\n- Si resolution_ok=true => resolution_status != \"fallido\" y no_resolution_reason=null.\n- Si escalado=false => escalacion_* = null y handoff_quality=null.\n- Si (resolution_ok=true) OR (escalado=true) OR (error_detectado=true) => evidence_message_ids no puede ser [].\n- Usa español.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -144,
        1056
      ],
      "id": "10780cdb-6ac0-4297-90bb-52c85746f86c",
      "name": "AI Agent_Delivery_9"
    },
    {
      "parameters": {
        "jsCode": "// Iteramos sobre todos los items\nreturn items.map(item => {\n  try {\n    // 1. Obtenemos el string\n    let rawContent = item.json.output || \"\";\n\n    // 2. Limpieza de Markdown (Como antes)\n    let cleanContent = rawContent\n      .replace(/^```json\\s*/i, '')\n      .replace(/^```\\s*/i, '')\n      .replace(/\\s*```$/, '')\n      .trim();\n\n    // -----------------------------------------------------------\n    // 3. REPARACIÓN DE JSON ROTO (El Parche)\n    // -----------------------------------------------------------\n    // El error es: cierra una propiedad con \", en lugar de },\n    // Buscamos: Salto de linea (\\n) -> Espacios (\\s*) -> Comilla (\") -> Coma (,)\n    // Y lo reemplazamos por: },\n    // Nota: Usamos una Regex específica para no romper otros textos.\n    \n    cleanContent = cleanContent.replace(/(\\n\\s*)\"\\s*,/g, '$1},');\n\n    // -----------------------------------------------------------\n\n    // 4. Parseo\n    const parsedData = JSON.parse(cleanContent);\n\n    // 5. Retorno Exitoso\n    return {\n      json: parsedData\n    };\n\n  } catch (error) {\n    // Si falla de nuevo, te dará detalles más precisos\n    return {\n      json: {\n        error: true,\n        message: \"Aún fallando el parseo. Revisa 'cleaned_string' para ver el error.\",\n        original_error: error.message,\n        // Devolvemos el string limpio para que veas si el parche funcionó visualmente\n        cleaned_string: error.input_string_debug \n      }\n    };\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        1056
      ],
      "id": "0b70fa27-46b6-4e21-ae38-6c5ef5cc4b13",
      "name": "Normaliza Salida_Delivery_9"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "osaki_analytics",
          "mode": "list",
          "cachedResultName": "osaki_analytics"
        },
        "table": {
          "__rl": true,
          "value": "auditoria_conversacion_delivery",
          "mode": "list",
          "cachedResultName": "auditoria_conversacion_delivery"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "resolution_ok": "={{ $json.resolution_ok }}",
            "confirmacion_explicita": "={{ $json.confirmacion_explicita }}",
            "consistencia_sucursal": "={{ $json.consistencia_sucursal }}",
            "escalado": "={{ $json.escalado }}",
            "afirmacion_estado_sin_fuente": "={{ $json.afirmacion_estado_sin_fuente }}",
            "afirmacion_eta_sin_fuente": "={{ $json.afirmacion_eta_sin_fuente }}",
            "error_detectado": "={{ $json.error_detectado }}",
            "channel": "WhatsApp",
            "agent": "Delivery",
            "brand": "Osaki",
            "sucursal_detectada": "Calle 9",
            "first_user_ts": "={{ $json.first_user_ts }}",
            "last_user_ts": "={{ $json.last_user_ts }}",
            "duration_sec": "={{ $json.duration_sec }}",
            "session_count": "={{ $json.session_count }}",
            "session_rule": "={{ $json.session_rule }}",
            "max_gap_minutes": "={{ $json.max_gap_minutes }}",
            "msg_count_total": "={{ $json.msg_count_total }}",
            "msg_count_ai": "={{ $json.msg_count_ai }}",
            "msg_count_human": "={{ $json.msg_count_human }}",
            "turn_count": "={{ $json.turn_count }}",
            "intent_principal": "={{ $json.intent_principal }}",
            "intents_secundarios": "={{ $json.intents_secundarios }}",
            "resolution_status": "={{ $json.resolution_status }}",
            "no_resolution_reason": "={{ $json.no_resolution_reason }}",
            "pedido_accion": "={{ $json.pedido_accion }}",
            "pedido_codigo": "={{ $json.pedido_codigo }}",
            "pedido_plataforma": "={{ $json.pedido_plataforma }}",
            "pedido_tipo_entrega": "={{ $json.pedido_tipo_entrega }}",
            "pedido_estado": "={{ $json.pedido_estado }}",
            "pedido_fecha": "={{ $json.pedido_fecha }}",
            "pedido_hora": "={{ $json.pedido_hora }}",
            "cliente_nombre": "={{ $json.cliente_nombre }}",
            "repreguntas_count": "={{ $json.repreguntas_count }}",
            "claridad_siguiente_paso": "={{ $json.claridad_siguiente_paso }}",
            "friccion_score": "={{ $json.friccion_score }}",
            "sentiment_inicio": "={{ $json.sentiment_inicio }}",
            "sentiment_final": "={{ $json.sentiment_final }}",
            "tono_ai": "={{ $json.tono_ai }}",
            "escalacion_tipo": "={{ $json.escalacion_tipo }}",
            "escalacion_turno": "={{ $json.escalacion_turno }}",
            "handoff_quality": "={{ $json.handoff_quality }}",
            "error_tipo": "={{ $json.error_tipo }}",
            "riesgo_negocio": "={{ $json.riesgo_negocio }}",
            "improvement_tag": "={{ $json.improvement_tag }}",
            "evidence_message_ids": "={{ $json.evidence_message_ids }}",
            "evidence_snippet": "={{ $json.evidence_snippet }}",
            "datos_faltantes": "={{ $json.datos_faltantes }}",
            "entidades_json": "={{ $json.entidades_json }}",
            "analyzed_by": "={{ $json.analyzed_by }}",
            "messages_json": "={{ { \"conversacion\": $('Aggregate_Delivery_9').item.json.data } }}",
            "analyzed_at": "={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat(\"yyyy-MM-dd'T'HH:mm:ss.000'Z'\") }}",
            "session_id": "={{ $('Loop Over Items_Delivery_9').item.json.session_id }}",
            "mes_analisis": "={{ $('Initial Data').item.json.mes_anterior }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "audit_id",
              "displayName": "audit_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent",
              "displayName": "agent",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "brand",
              "displayName": "brand",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sucursal_detectada",
              "displayName": "sucursal_detectada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_user_ts",
              "displayName": "first_user_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_user_ts",
              "displayName": "last_user_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "duration_sec",
              "displayName": "duration_sec",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_count",
              "displayName": "session_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_rule",
              "displayName": "session_rule",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "max_gap_minutes",
              "displayName": "max_gap_minutes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_total",
              "displayName": "msg_count_total",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_ai",
              "displayName": "msg_count_ai",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "msg_count_human",
              "displayName": "msg_count_human",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "turn_count",
              "displayName": "turn_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "intent_principal",
              "displayName": "intent_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "intents_secundarios",
              "displayName": "intents_secundarios",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "resolution_status",
              "displayName": "resolution_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "resolution_ok",
              "displayName": "resolution_ok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "no_resolution_reason",
              "displayName": "no_resolution_reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_accion",
              "displayName": "pedido_accion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_codigo",
              "displayName": "pedido_codigo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_plataforma",
              "displayName": "pedido_plataforma",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_tipo_entrega",
              "displayName": "pedido_tipo_entrega",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_estado",
              "displayName": "pedido_estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_fecha",
              "displayName": "pedido_fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "pedido_hora",
              "displayName": "pedido_hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true
            },
            {
              "id": "cliente_nombre",
              "displayName": "cliente_nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirmacion_explicita",
              "displayName": "confirmacion_explicita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "repreguntas_count",
              "displayName": "repreguntas_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "claridad_siguiente_paso",
              "displayName": "claridad_siguiente_paso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "consistencia_sucursal",
              "displayName": "consistencia_sucursal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "friccion_score",
              "displayName": "friccion_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "sentiment_inicio",
              "displayName": "sentiment_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sentiment_final",
              "displayName": "sentiment_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tono_ai",
              "displayName": "tono_ai",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalado",
              "displayName": "escalado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalacion_tipo",
              "displayName": "escalacion_tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "escalacion_turno",
              "displayName": "escalacion_turno",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "handoff_quality",
              "displayName": "handoff_quality",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "afirmacion_estado_sin_fuente",
              "displayName": "afirmacion_estado_sin_fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "afirmacion_eta_sin_fuente",
              "displayName": "afirmacion_eta_sin_fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_detectado",
              "displayName": "error_detectado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_tipo",
              "displayName": "error_tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "riesgo_negocio",
              "displayName": "riesgo_negocio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "improvement_tag",
              "displayName": "improvement_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "evidence_message_ids",
              "displayName": "evidence_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "evidence_snippet",
              "displayName": "evidence_snippet",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_faltantes",
              "displayName": "datos_faltantes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "entidades_json",
              "displayName": "entidades_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "messages_json",
              "displayName": "messages_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "analyzed_by",
              "displayName": "analyzed_by",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "analyzed_at",
              "displayName": "analyzed_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "mes_analisis",
              "displayName": "mes_analisis",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        400,
        1056
      ],
      "id": "a665c01c-a7d1-460c-a326-d421e1296c47",
      "name": "Registra Analisis_Delivery_9",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "faf12f8f-17b5-473d-8de0-2a2fc8038ca4",
              "leftValue": "={{ $json.success }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -768,
        1120
      ],
      "id": "fd76e91b-f9cd-446a-95f7-8d7b9292d50c",
      "name": "If"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "faf12f8f-17b5-473d-8de0-2a2fc8038ca4",
              "leftValue": "={{ $json.success }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -800,
        672
      ],
      "id": "20635720-956a-4f49-a930-ca8158ef942b",
      "name": "If1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "faf12f8f-17b5-473d-8de0-2a2fc8038ca4",
              "leftValue": "={{ $json.success }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -800,
        272
      ],
      "id": "2b3c5dd5-663b-42a7-a263-d85b58953e13",
      "name": "If2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 0 3 1 * * "
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1968,
        656
      ],
      "id": "39259780-4913-4d9c-bb9d-2ccde405254c",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "\nSELECT DISTINCT ch.session_id\n       --ch.ultimos_10_numeros\nFROM (\n    SELECT session_id,\n           RIGHT(SPLIT_PART(session_id, '@', 1), 10) as ultimos_10_numeros\n    FROM (\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n        UNION\n        SELECT session_id\n        FROM osaki_main.n8n_chat_histories_bkup\n        WHERE fec_registro BETWEEN '{{ $json.fec_initial }}' AND '{{ $json.fec_final }}'\n    ) t\n) ch\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM osaki_analytics.auditoria_conversacion_reservas a\n    WHERE a.session_id = ch.session_id\n    AND a.mes_analisis = '{{ $json.mes_anterior }}'\n)\nAND NOT EXISTS (\n    SELECT 1\n    FROM osaki_main.blacklist_phones_calle_47 b\n    WHERE b.phone = ch.ultimos_10_numeros::bigint\n)\nORDER BY ch.session_id ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1264,
        256
      ],
      "id": "58eb16af-8c11-45c6-ad83-9c519c86dc71",
      "name": "Get Session Id",
      "credentials": {
        "postgres": {
          "id": "sk75eTZ4yDkbl8mt",
          "name": "Postgres Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8d3fec7f-2a0c-4baf-87cf-8270fd3993a2",
              "name": "schema_analytics",
              "value": "osaki_analytics",
              "type": "string"
            },
            {
              "id": "39321030-5d85-4f15-a9f3-e9f63fd58c1f",
              "name": "schema_data",
              "value": "osaki_main",
              "type": "string"
            },
            {
              "id": "cc789ac2-2002-4da4-97f9-607b7fc9b10a",
              "name": "fec_initial",
              "value": "={{ $now.setZone('America/Argentina/Buenos_Aires').minus({ months: 1 }).startOf('month').toFormat('yyyy-MM-dd') }}",
              "type": "string"
            },
            {
              "id": "a7b2348e-ee7b-4315-ac82-94588a9c2a3c",
              "name": "fec_final",
              "value": "={{ $now.setZone('America/Argentina/Buenos_Aires').startOf('month').toFormat('yyyy-MM-dd') }}",
              "type": "string"
            },
            {
              "id": "40fd67c4-188b-49f7-b8a6-6a2b732dd727",
              "name": "mes_anterior",
              "value": "={{ $now.setZone('America/Argentina/Buenos_Aires').minus({ months: 1 }).setLocale('es').toFormat('MMMM').replace(/^\\w/, (c) => c.toUpperCase()) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1696,
        656
      ],
      "id": "0b39ba64-b501-4619-b68b-2278e25e6356",
      "name": "Initial Data"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -80,
        720
      ],
      "id": "2d919cfb-659a-4c26-8764-4b0fb80adb3a",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "fATP1TjAWkMAqBDc",
          "name": "OpenAi Osaki-TemikiaProd01"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -176,
        720
      ],
      "id": "6bf3d67b-0fcb-45e8-aec8-ab2dd80043a6",
      "name": "Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "OAlDnAQJQHCtNBVS",
          "name": "Google Gemini(PaLM) Osaki-TemikiaProd01"
        }
      }
    }
  ],
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "timezone": "America/Argentina/Buenos_Aires",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "ZpYgShc1li13uf3h"
  },
  "shared": [
    {
      "updatedAt": "2025-12-25T18:52:42.693Z",
      "createdAt": "2025-12-25T18:52:42.693Z",
      "role": "workflow:owner",
      "workflowId": "kKkB2zB1kibZ3wus",
      "projectId": "ROVo9T66IPW6MHN4"
    }
  ],
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [
    {
      "updatedAt": "2026-01-11T14:04:54.833Z",
      "createdAt": "2026-01-11T14:04:54.833Z",
      "id": "tt10iwS1I1BhsjLZ",
      "name": "Analytics"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2026-01-11T21:20:26.819Z",
  "versionId": "fcb8c632-a0be-4420-8074-a1f3a280b1e3"
}